<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: http://localhost:8080;">
    <title>PlantUML Viewer (Secure)</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
            margin-top: 0;
        }
        .security-badge {
            display: inline-block;
            background: #4CAF50;
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
            vertical-align: middle;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        .tab:hover {
            color: #4CAF50;
        }
        .tab.active {
            color: #4CAF50;
            border-bottom-color: #4CAF50;
        }
        .content {
            display: none;
        }
        .content.active {
            display: block;
        }
        #diagram {
            text-align: center;
            margin: 20px 0;
            min-height: 200px;
        }
        #diagram img {
            max-width: 100%;
            height: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        #source {
            background: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            white-space: pre-wrap;
            font-family: 'Courier New', Monaco, monospace;
            font-size: 14px;
            line-height: 1.5;
            overflow-x: auto;
            margin: 0;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #c62828;
            margin: 20px 0;
        }
        .warning {
            background: #fff3e0;
            color: #ef6c00;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #ef6c00;
            margin: 20px 0;
        }
        .info {
            background: #e3f2fd;
            color: #1565c0;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #1565c0;
            margin: 20px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            PlantUML Diagram Viewer
            <span class="security-badge">üîí SECURE</span>
        </h1>
        
        <div class="info">
            ‚ÑπÔ∏è <strong>–†–µ–∂–∏–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:</strong> –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã. –î–∏–∞–≥—Ä–∞–º–º—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ.
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('diagram')">–î–∏–∞–≥—Ä–∞–º–º–∞</button>
            <button class="tab" onclick="showTab('source')">–ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥</button>
        </div>
        
        <div id="diagram-content" class="content active">
            <div id="diagram" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∏–∞–≥—Ä–∞–º–º—ã</div>
        </div>
        
        <div id="source-content" class="content">
            <pre id="source"></pre>
        </div>
    </div>

    <!-- –õ–æ–∫–∞–ª—å–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –≤–º–µ—Å—Ç–æ CDN -->
    <script src="/libs/pako.min.js"></script>
    <script>
        'use strict';

        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const CONFIG = {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π PlantUML —Å–µ—Ä–≤–µ—Ä
            plantUMLServer: 'http://localhost:8080/png/',
            
            // –†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤
            allowedExtensions: ['.plant', '.plantuml', '.puml', '.uml'],
            
            // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (1MB)
            maxFileSize: 1024 * 1024,
            
            // –¢–∞–π–º–∞—É—Ç –∑–∞–≥—Ä—É–∑–∫–∏
            fetchTimeout: 10000
        };

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–∞–±–æ–≤
        function showTab(tabName) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.content');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            contents.forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            const targetContent = document.getElementById(tabName + '-content');
            if (targetContent) {
                targetContent.classList.add('active');
            }
        }

        // –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ URL
        function isSecureUrl(url) {
            try {
                const urlObj = new URL(url, window.location.origin);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º origin
                if (urlObj.origin !== window.location.origin) {
                    console.error('[Security] External URL blocked:', urlObj.origin);
                    return false;
                }
                
                // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø—É—Ç–∏
                const path = urlObj.pathname;
                const segments = path.split('/').filter(Boolean);
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ path traversal
                for (const segment of segments) {
                    if (segment === '..' || segment === '.') {
                        console.error('[Security] Path traversal attempt blocked');
                        return false;
                    }
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ–∞–π–ª–∞
                const hasValidExtension = CONFIG.allowedExtensions.some(ext => 
                    path.toLowerCase().endsWith(ext)
                );
                
                if (!hasValidExtension) {
                    console.error('[Security] Invalid file extension');
                    return false;
                }
                
                return true;
            } catch (e) {
                console.error('[Security] Invalid URL:', e);
                return false;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —É–∑–ª–∞
        function createSafeElement(tag, content, isText = true) {
            const element = document.createElement(tag);
            if (isText) {
                element.textContent = content; // –ë–µ–∑–æ–ø–∞—Å–Ω–æ –æ—Ç XSS
            }
            return element;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—à–∏–±–æ–∫
        function showError(message) {
            const diagram = document.getElementById('diagram');
            diagram.innerHTML = ''; // –û—á–∏—â–∞–µ–º
            
            const errorDiv = createSafeElement('div', '', false);
            errorDiv.className = 'error';
            
            const errorText = createSafeElement('span', `‚ùå –û—à–∏–±–∫–∞: ${message}`);
            errorDiv.appendChild(errorText);
            
            diagram.appendChild(errorDiv);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
        function showWarning(message) {
            const diagram = document.getElementById('diagram');
            
            const warningDiv = createSafeElement('div', '', false);
            warningDiv.className = 'warning';
            
            const warningText = createSafeElement('span', `‚ö†Ô∏è ${message}`);
            warningDiv.appendChild(warningText);
            
            diagram.insertBefore(warningDiv, diagram.firstChild);
        }

        // –ö–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ PlantUML
        function encode64(data) {
            let r = "";
            for (let i = 0; i < data.length; i += 3) {
                if (i + 2 === data.length) {
                    r += append3bytes(data[i], data[i + 1], 0);
                } else if (i + 1 === data.length) {
                    r += append3bytes(data[i], 0, 0);
                } else {
                    r += append3bytes(data[i], data[i + 1], data[i + 2]);
                }
            }
            return r;
        }

        function append3bytes(b1, b2, b3) {
            const c1 = b1 >> 2;
            const c2 = ((b1 & 0x3) << 4) | (b2 >> 4);
            const c3 = ((b2 & 0xF) << 2) | (b3 >> 6);
            const c4 = b3 & 0x3F;
            let r = "";
            r += encode6bit(c1 & 0x3F);
            r += encode6bit(c2 & 0x3F);
            r += encode6bit(c3 & 0x3F);
            r += encode6bit(c4 & 0x3F);
            return r;
        }

        function encode6bit(b) {
            if (b < 10) return String.fromCharCode(48 + b);
            b -= 10;
            if (b < 26) return String.fromCharCode(65 + b);
            b -= 26;
            if (b < 26) return String.fromCharCode(97 + b);
            b -= 26;
            if (b === 0) return '-';
            if (b === 1) return '_';
            return '?';
        }

        function encodePlantUML(text) {
            const utf8Bytes = new TextEncoder().encode(text);
            const compressed = pako.deflateRaw(utf8Bytes, {level: 9});
            return encode64(compressed);
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å —Ç–∞–π–º–∞—É—Ç–æ–º
        async function fetchWithTimeout(url, timeout = CONFIG.fetchTimeout) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);
            
            try {
                const response = await fetch(url, {
                    signal: controller.signal,
                    credentials: 'same-origin' // –¢–æ–ª—å–∫–æ same-origin –∑–∞–ø—Ä–æ—Å—ã
                });
                clearTimeout(timeoutId);
                return response;
            } catch (error) {
                clearTimeout(timeoutId);
                throw error;
            }
        }

        // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∏–∞–≥—Ä–∞–º–º—ã
        async function loadDiagram() {
            const urlParams = new URLSearchParams(window.location.search);
            let file = urlParams.get('file');
            
            if (!file) {
                showError('–§–∞–π–ª –Ω–µ —É–∫–∞–∑–∞–Ω. –î–æ–±–∞–≤—å—Ç–µ ?file=yourfile.plant –∫ URL');
                return;
            }

            try {
                // –î–µ–∫–æ–¥–∏—Ä—É–µ–º URL
                file = decodeURIComponent(file);
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∞–±—Å–æ–ª—é—Ç–Ω—ã–π URL
                if (file.match(/^https?:\/\//)) {
                    const fileUrl = new URL(file);
                    if (fileUrl.origin !== window.location.origin) {
                        throw new Error('–í–Ω–µ—à–Ω–∏–µ URL –∑–∞–ø—Ä–µ—â–µ–Ω—ã –ø–æ —Å–æ–æ–±—Ä–∞–∂–µ–Ω–∏—è–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏');
                    }
                    file = fileUrl.pathname;
                }
                
                // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø—É—Ç–∏
                file = file.replace(/\/+/g, '/');
                
                // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø—É—Ç–∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                if (!file.startsWith('/')) {
                    const currentPath = window.location.pathname.substring(
                        0, 
                        window.location.pathname.lastIndexOf('/')
                    );
                    file = currentPath + '/' + file;
                }
                
                // –°–æ–∑–¥–∞–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ URL
                const fullUrl = new URL(file, window.location.origin);
                
                if (!isSecureUrl(fullUrl.href)) {
                    throw new Error('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω: URL –Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω');
                }

                // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
                console.log('[Info] Loading file:', file);
                const response = await fetchWithTimeout(file);
                
                if (!response.ok) {
                    throw new Error(`–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω (HTTP ${response.status})`);
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞
                const contentLength = response.headers.get('content-length');
                if (contentLength && parseInt(contentLength) > CONFIG.maxFileSize) {
                    throw new Error('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π');
                }
                
                let plantUMLSource = await response.text();
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
                if (plantUMLSource.length > CONFIG.maxFileSize) {
                    throw new Error('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π');
                }
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ @startuml/@enduml
                if (!plantUMLSource.trim().match(/^@start/)) {
                    plantUMLSource = '@startuml\n' + plantUMLSource + '\n@enduml';
                }
                
                // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞ (–±–µ–∑–æ–ø–∞—Å–Ω–æ —á–µ—Ä–µ–∑ textContent)
                document.getElementById('source').textContent = plantUMLSource;
                
                // –ö–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ URL –¥–∏–∞–≥—Ä–∞–º–º—ã
                const encoded = encodePlantUML(plantUMLSource);
                const imageUrl = CONFIG.plantUMLServer + encoded;
                
                // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                const diagram = document.getElementById('diagram');
                diagram.innerHTML = '';
                
                const img = document.createElement('img');
                img.src = imageUrl;
                img.alt = 'PlantUML Diagram';
                img.onerror = handleImageError;
                
                diagram.appendChild(img);
                
                console.log('[Info] Diagram loaded successfully');
                
            } catch (error) {
                console.error('[Error]', error);
                showError(error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
            }
        }

        function handleImageError() {
            showError('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –¥–∏–∞–≥—Ä–∞–º–º—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å PlantUML –∏–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞.');
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        if (typeof pako === 'undefined') {
            showError('–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ pako –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É—Ç—å –∫ /libs/pako.min.js');
        } else {
            loadDiagram();
        }
    </script>
</body>
</html>