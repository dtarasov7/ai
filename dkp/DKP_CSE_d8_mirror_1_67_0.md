# Доставка образов DKP CSE в закрытое окружение

- Доставка образов DKP CSE в закрытое окружение
  - [Требования](#требования)
  - [Общий подход к доставке образов DKP в закрытое окружение](#общий-подход-к-доставке-образов-dkp-в-закрытое-окружение)
  - [Шаг 1: выгрузка образов DKP на рабочую станцию](#шаг-1-выгрузка-образов-dkp-на-рабочую-станцию)
  - [Шаг 2: загрузка образов DKP в Репозиторий](#шаг-2-загрузка-образов-dkp-в-репозиторий)

## Требования

1. Репозиторий образов контейнеров (далее Репозиторий) на базе одного из [поддерживаемых решений](https://deckhouse.ru/products/kubernetes-platform/documentation/v1/supported_versions.html#container-registry).
2. Не менее 16 Гбайт свободного дискового пространства в Репозитории.
3. Сетевой доступ к портам Репозитория должен предоставляться без ограничений для всех целевых узлов.
4. Доменное имя (в случае использования) Репозитория должно разрешаться для всех целевых узлов.
5. Рабочая станция или сервер (далее Станция) для проведения работ по выгрузке / загрузке образов DKP на базе ОС Linux, MacOS X, Windows.
6. Не менее 16 Гбайт свободного дискового пространства на Станции.
7. Установленная на Станции утилита `d8`. Загрузить утилиту можно [по ссылке](https://deckhouse.ru/products/kubernetes-platform/documentation/v1/deckhouse-cli/). Версия утилиты d8 для работы с платформой должна быть не ниже `v0.11.0`.
8. Доступ к `registry-cse.deckhouse.ru` через Интернет со Станции по протоколу 443/tcp (HTTPS).

Под целевыми узлами понимаются:

- Узлы платформы DKP;
- Рабочие станции или серверы, с которых осуществляется управление Репозиторием, включая загрузку образов.

## Общий подход к доставке образов DKP в закрытое окружение

1. Выгрузка образов DKP через Интернет на рабочую станцию в виде архива;
2. Перенос архива и утилиты `d8` в закрытое окружение;
3. Загрузка образов DKP в Репозиторий в закрытом окружении.

## Шаг 1: выгрузка образов DKP на рабочую станцию

1. Выберите произвольный каталог на рабочей станции и создайте скрипт `pull.sh` со следующим содержимым:

   ```bash
   #!/bin/bash

   RELEASE='v1.67.0'
   LICENSE_KEY='ВАШ_ЛИЦЕНЗИОННЫЙ_КЛЮЧ'
   PACKAGE_PATH="$(pwd)/ваш/каталог"

   d8 mirror pull \
     ${PACKAGE_PATH} \
     --source="registry-cse.deckhouse.ru/deckhouse/cse" \
     --license="${LICENSE_KEY}" \
     --deckhouse-tag="${RELEASE}" \
     --no-modules \
     --gost-digest
   ```

2. Выдайте права на выполнения этому скрипту:

   ```bash
   chmod +x pull.sh
   ```

3. Запустите скрипт `pull.sh` и дождитесь завершения его выполнения.

   Результатом выполнения скрипта будут четыре файла в указанном каталоге:

   - platform.tar - архив с образами DKP.
   - platform.tar.gostsum - файл, содержащий контрольную сумму, сформированную для архива `platform.tar`. Проверка целостности может быть осуществлена с помощью утилиты `gostsum` (не входит в поставку).
   - security.tar - архив с образами баз данных уязвимостей.
   - security.tar.gostsum - файл, содержащий контрольную сумму, сформированную для архива `security.tar`. Проверка целостности может быть осуществлена с помощью утилиты `gostsum` (не входит в поставку).

4. Перенесите указанные выше файлы, а также утилиту `d8` (при необходимости), на рабочую станцию / узел в закрытом окружении.

## Шаг 2: загрузка образов DKP в Репозиторий

1. Создайте скрипт `push.sh` со следующим содержимым:

    ```bash
    #!/bin/bash

    USER='ВАШЕ_ИМЯ_ПОЛЬЗОВАТЕЛЯ'
    PASSWORD='ВАШЕ_ИМЯ_ПАРОЛЬ'
    REGISTRY_PATH='ПОЛНЫЙ_ПУТЬ_ДО_РЕПОЗИТОРИЯ' # Пример: registry.example.com:5000/dkp/cse
    PACKAGE_PATH="$(pwd)/ваш/каталог"
    
    d8 mirror push \
      ${PACKAGE_PATH} \
      ${REGISTRY_PATH} \
      --registry-login="${USER}" \
      --registry-password="${PASSWORD}"
    ```

2. Выдайте права на выполнения этому скрипту:

    ```bash
    chmod +x push.sh
    ```

3. Запустите скрипт `push.sh` и дождитесь завершения его выполнения.

4. Убедитесь, что в Репозитории по указанному пути появились образы DKP.

Например, для проверки можно выполнить следующие команды с узла в закрытом окружении, предварительно заменив `registry.example.com:5000/dkp/cse` на ваш путь до образов DKP в Репозитории:

```bash
docker login registry.example.com:5000/dkp/cse
docker pull registry.example.com:5000/dkp/cse/install:v1.67.0
```

Результатом выполнения команд выше будет загруженный на узел установочный образ для DKP CSE v1.67.0.
