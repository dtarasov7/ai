Чтобы настроить Nginx для логирования информации о трассировке, когда конкретный используемый стандарт (W3C, B3 или другой) неизвестен, лучшим подходом будет создание специального формата лога, который захватывает заголовки всех распространённых систем трассировки.

Вы можете определить новый формат лога с помощью директивы `log_format`, который будет включать переменные для различных заголовков трассировки. Nginx позволяет получить доступ к любому заголовку запроса с помощью переменной `$http_<имя_заголовка>`, где дефисы в имени заменены на подчеркивания.

Ниже приведена конфигурация Nginx, которая решает эту задачу.

### Конфигурация Nginx для логирования трассировки

Эту конфигурацию следует добавить в секцию `http` вашего основного файла `nginx.conf`.

```nginx
http {
    # ... другие ваши настройки ...

    # 1. Определение формата лога для трассировки
    # Этот формат расширяет стандартный формат 'combined'
    # и добавляет в конец лога значения различных заголовков трассировки.
    # Если заголовок отсутствует в запросе, его значение будет записано как "-".

    log_format trace_log '$combined'
                         ' w3c_traceparent="$http_traceparent"'
                         ' w3c_tracestate="$http_tracestate"'
                         ' b3_traceid="$http_x_b3_traceid"'
                         ' b3_spanid="$http_x_b3_spanid"'
                         ' b3_parentspanid="$http_x_b3_parentspanid"'
                         ' b3_sampled="$http_x_b3_sampled"'
                         ' amzn_trace_id="$http_x_amzn_trace_id"'
                         ' dd_trace_id="$http_x_datadog_trace_id"'
                         ' dd_parent_id="$http_x_datadog_parent_id"'
                         ' request_id="$http_request_id"';

    # 2. Применение созданного формата к файлу лога доступа
    # Эта директива может быть как на уровне http, так и на уровне server.
    access_log /var/log/nginx/access.log trace_log;

    server {
        listen 80;
        server_name example.com;

        # Если вы хотите использовать этот формат лога только для конкретного сервера,
        # разместите директиву access_log здесь:
        # access_log /var/log/nginx/example.com.access.log trace_log;

        location / {
            proxy_pass http://my_backend;
            # ... другие настройки ...
        }
    }
}
```

### Пояснение конфигурации

1.  **`log_format trace_log`**: Эта директива создает новый формат лога с именем `trace_log`.
    *   Он начинается с `$combined`, что включает в себя все поля стандартного формата логов Nginx (IP-адрес клиента, время запроса, статус ответа и т.д.).
    *   Далее добавляются пары "ключ=значение" для каждого потенциального заголовка трассировки. Это делает логи более читаемыми.

2.  **Переменные заголовков трассировки**:
    *   **W3C Trace Context**: `traceparent` и `tracestate` являются стандартными заголовками W3C. В Nginx они доступны как `$http_traceparent` и `$http_tracestate`.
    *   **B3 Propagation**: Этот стандарт, популяризированный Zipkin, использует несколько заголовков, таких как `X-B3-TraceId`, `X-B3-SpanId`, `X-B3-ParentSpanId` и `X-B3-Sampled`.
    *   **AWS/Amazon**: Балансировщики нагрузки Amazon используют заголовок `X-Amzn-Trace-Id`.
    *   **Datadog**: Datadog использует свои заголовки, например `x-datadog-trace-id` и `x-datadog-parent-id`.
    *   **Общий Request ID**: Часто используется заголовок `Request-ID` для уникальной идентификации запроса.

3.  **`access_log`**: Эта директива указывает Nginx использовать созданный формат `trace_log` для записи логов доступа в указанный файл.

### Пример строки в логе

После применения этой конфигурации, если придет запрос с заголовками трассировки W3C, строка в вашем файле `/var/log/nginx/access.log` будет выглядеть примерно так:

```
192.168.1.10 - - [06/Nov/2025:10:30:00 +0000] "GET /api/users HTTP/1.1" 200 1234 "-" "curl/7.64.1" w3c_traceparent="00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-01" w3c_tracestate="rojo=00f067aa0ba902b7" b3_traceid="-" b3_spanid="-" b3_parentspanid="-" b3_sampled="-" amzn_trace_id="-" dd_trace_id="-" dd_parent_id="-" request_id="-"
```

Как видно из примера, значения присутствующих заголовков (`w3c_traceparent`, `w3c_tracestate`) записаны, а отсутствующие отображаются как `"-"`. Такой подход гарантирует, что вы будете собирать данные о трассировке независимо от того, какой из популярных стандартов используется в вашей инфраструктуре.
