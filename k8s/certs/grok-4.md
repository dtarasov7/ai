### Оптимальная стратегия использования сертификатов в Deckhouse в изолированном корпоративном окружении

Deckhouse Kubernetes Platform (DKP) — это мощная экосистема для управления Kubernetes-кластерами, которая включает модуль cert-manager для автоматизации работы с сертификатами. В изолированном корпоративном окружении, где выпуск сертификатов через API невозможен и все операции по выпуску должны происходить вне кластера в ручном режиме (например, с использованием корпоративного центра сертификации, такого как Microsoft CA или аналогичного), стратегия должна фокусироваться на безопасности, минимальной автоматизации внутри кластера и строгом контроле процессов. Это особенно актуально для сертифицированных версий DKP (например, Certified Security Edition, прошедшей сертификацию ФСТЭК России, как указано в обновлениях на deckhouse.ru), где соблюдаются требования к изоляции и безопасности.

Я опишу стратегию шаг за шагом, охватывая создание, обновление и лучшие практики. Она основана на документации Deckhouse (модуль cert-manager) и общих рекомендациях по управлению сертификатами в изолированных средах, таких как описанные в материалах Microsoft по Windows Certificate Manager и PowerShell. Предполагается, что у вас есть доступ к корпоративному CA вне кластера для ручного подписания запросов.

#### 1. **Подготовка и настройка в Deckhouse**
   - **Установите модуль cert-manager в Deckhouse.**  
     Это базовый компонент для управления сертификатами внутри кластера. В Deckhouse cert-manager устанавливается автоматически с учетом особенностей кластера (например, webhook для kube-apiserver). Активируйте его через конфигурацию Deckhouse:
     ```
     apiVersion: deckhouse.io/v1
     kind: ModuleConfig
     metadata:
       name: cert-manager
     spec:
       enabled: true
       values:
         # Дополнительные настройки, если нужны (например, для высокой доступности)
     ```
     Cert-manager позволит генерировать Certificate Signing Requests (CSR) внутри кластера, но подписание будет ручным вне кластера.

   - **Настройте ClusterIssuer типа 'ca' или 'selfsigned' как fallback.**  
     - Создайте ClusterIssuer с типом 'ca', импортировав корневой сертификат вашего корпоративного CA (если он доступен для импорта). Это позволит cert-manager проверять цепочки доверия, но не выпускать сертификаты автоматически.
     - Пример YAML для ClusterIssuer:
       ```
       apiVersion: cert-manager.io/v1
       kind: ClusterIssuer
       metadata:
         name: corporate-ca
       spec:
         ca:
           secretName: corporate-ca-secret  # Secret с корневым CA сертификатом (импортируйте вручную)
       ```
     - Если корпоративный CA не может быть импортирован напрямую, используйте 'selfsigned' для временных сертификатов внутри кластера, но это не рекомендуется для продакшена из-за рисков.

   - **Импортируйте корневые сертификаты в кластер.**  
     Вручную скопируйте корневой сертификат корпоративного CA в Kubernetes Secret (например, с помощью `kubectl create secret tls corporate-ca-secret --cert=ca.crt --key=ca.key`). Это обеспечит доверие к сертификатам внутри кластера (для компонентов вроде Ingress, Prometheus и т.д.).

#### 2. **Создание сертификатов (ручной выпуск вне кластера)**
   Поскольку API-выпуск невозможен, процесс создания должен быть строго ручным и разделенным между кластером и внешней средой. Цель — минимизировать риски утечки ключей и обеспечить аудит.

   - **Генерация CSR внутри кластера с помощью cert-manager.**  
     Создайте объект Certificate в Deckhouse, который сгенерирует CSR:
     ```
     apiVersion: cert-manager.io/v1
     kind: Certificate
     metadata:
       name: example-cert
       namespace: default
     spec:
       secretName: example-tls
       issuerRef:
         name: corporate-ca
         kind: ClusterIssuer
       commonName: example.domain.com
       dnsNames:
         - example.domain.com
     ```
     Cert-manager создаст CSR, но не подпишет его (поскольку нет API). Экспортируйте CSR из секрета или логов для дальнейшей обработки.

   - **Ручное подписание вне кластера.**  
     - Вынесите CSR из кластера (например, через `kubectl get secret example-tls -o jsonpath='{.data.tls\.csr}' | base64 -d > csr.pem`).
     - В корпоративной среде вне кластера используйте инструменты вроде Windows Certificate Manager или PowerShell для подписания CSR с помощью корпоративного CA. Пример PowerShell-команды для импорта и подписания (на основе материалов с blog.it-kb.ru):
       ```
       $csr = Get-Content -Path csr.pem
       $cert = Submit-CertificateRequest -CA "corporate-ca-server" -Request $csr
       Export-Certificate -Cert $cert -FilePath signed-cert.pem
       ```
     - Убедитесь, что подписание соответствует корпоративным политикам (например, использование сильных алгоритмов, как рекомендовано в обновлениях Microsoft для слабой криптографии).

   - **Импорт подписанного сертификата обратно в кластер.**  
     Создайте или обновите Secret в Kubernetes:
     ```
     kubectl create secret tls example-tls --cert=signed-cert.pem --key=private-key.pem
     ```
     Cert-manager может автоматически использовать этот секрет для компонентов Deckhouse (например, для Ingress или API-сервера).

   - **Частота создания:** Создавайте сертификаты только по необходимости (например, для новых доменов или сервисов). Используйте короткие сроки действия (90–180 дней) для повышения безопасности.

#### 3. **Обновление и ротация сертификатов**
   В изолированном окружении автоматизация ротации ограничена, поэтому акцент на мониторинг и ручные процедуры.

   - **Мониторинг сроков действия.**  
     Интегрируйте с модулем Prometheus в Deckhouse (deckhouse.ru/modules/prometheus/) для алертов о приближающемся истечении срока. Пример: Настройте Grafana-дашборд для метрик cert-manager, отслеживающих `certmanager_certificate_expiration_timestamp_seconds`.

   - **Процесс обновления:**  
     - За 30 дней до истечения срока сгенерируйте новый CSR в кластере (аналогично созданию).
     - Подпишите вручную вне кластера.
     - Обновите Secret в кластере и перезапустите поды/сервисы (например, `kubectl rollout restart deployment example-app`).
     - Для критических компонентов (например, etcd или kube-apiserver) используйте Deckhouse-специфические хуки для graceful ротации.

   - **Автоматизация внутри кластера (без API):**  
     Cert-manager поддерживает автообновление на основе аннотаций (например, `cert-manager.io/renew-before: "30d"`), но поскольку подписание ручное, настройте webhook или скрипты для уведомлений (например, через external-dns или custom controller). Избегайте полной автоматизации, чтобы соблюдать изоляцию.

   - **Частота ротации:** Проводите ежеквартально или при изменениях в инфраструктуре. Аудитируйте все обновления для соответствия стандартам (например, ФСТЭК для сертифицированной DKP).

#### Лучшие практики и соображения безопасности
- **Безопасность ключей:** Никогда не храните приватные ключи вне кластера дольше необходимого. Используйте HSM (Hardware Security Modules) для корпоративного CA, если доступно.
- **Аудит и контроль:** Ведите логи всех операций (в cert-manager и Prometheus). В сертифицированной DKP это интегрируется с модулями безопасности.
- **Тестирование:** В staging-окружении тестируйте процесс на копии кластера.
- **Ограничения изоляции:** Поскольку кластер изолирован, избегайте внешних интеграций (например, с Vault или ACME). Если нужны расширения, рассмотрите сертификацию администраторов DKP (deckhouse.ru/sertifikacziya-administratora-dkp/) для команды.
- **Источники:** Эта стратегия основана на официальной документации Deckhouse (deckhouse.ru/products/kubernetes-platform/documentation/v1/modules/cert-manager/) и рекомендациях по управлению сертификатами в enterprise-средах (например, от Microsoft и ФСТЭК).

Эта стратегия обеспечивает баланс между безопасностью и удобством в изолированном окружении. Если у вас есть дополнительные детали о вашей инфраструктуре (например, версия DKP или тип CA), я могу уточнить рекомендации.
