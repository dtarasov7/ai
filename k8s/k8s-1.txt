Для настройки мониторинга кластера Kubernetes в Zabbix, важно охватить критические компоненты, связанные с доступностью и работоспособностью системы. Ниже приведен список метрик, которые помогут оперативно выявлять проблемы, минимизируя избыточные алерты:

---

### **1. Проверка доступности внешнего балансировщика (LB)**  
- **Недоступность VIP (виртуального IP-адреса) через Keepalived**  
  Проверка: ICMP-пинг или TCP-соединение к портам 443/6443.  
  Причина: Сбой одного из серверов LB или некорректная синхронизация между ними.  
  Источник: Анализ отказоустойчивости LB .  

- **Состояние Nginx на каждом сервере LB**  
  Проверка: Статус процесса Nginx и открытие портов (например, `netstat -tuln | grep 80/443/6443`).  
  Причина: Падение сервиса Nginx на одном из серверов.  

- **Ошибки в логах Nginx**  
  Проверка: Мониторинг строк "Connection refused", "5xx ошибки" в `/var/log/nginx/error.log`.  
  Причина: Проблемы с маршрутизацией запросов на master/ingress.  

---

### **2. Проверка состояния Control Plane (master-узлов)**  
- **Недоступность kube-apiserver через LB**  
  Проверка: HTTP-запрос к `https://<LB_IP>:6443/healthz` с ожидаемым ответом `ok`.  
  Причина: Сбой всех master-узлов или проблема с балансировкой.  
  Источник: Роль kube-apiserver в Kubernetes .  

- **Состояние компонентов Control Plane**  
  Проверка: Статус сервисов `kube-apiserver`, `etcd`, `kube-controller-manager`, `kube-scheduler` на каждом master-узле.  
  Причина: Сбой одного из компонентов на отдельном master-узле.  

- **Сертификаты Control Plane**  
  Проверка: Валидность сертификатов (`/etc/kubernetes/pki/*.crt`) за 30 дней до истечения.  
  Причина: Истечение сертификатов приведет к недоступности API.  

---

### **3. Проверка узлов (nodes)**  
- **Статус узлов**  
  Проверка: Все узлы должны быть в состоянии `Ready`.  
  Причина: Сбой worker- или master-узла.  

- **Ресурсы узлов**  
  Проверка: Использование CPU, памяти, диска (>80% — предупреждение, >95% — критический алерт).  
  Причина: Ограниченные ресурсы могут вызвать evicted-поды.  

- **Контроль здоровья kubelet**  
  Проверка: Статус сервиса `kubelet` и доступность порта `10248/healthz`.  

---

### **4. Проверка Ingress-контроллеров**  
- **Состояние Ingress-подов**  
  Проверка: Все поды Ingress (например, NGINX Ingress Controller) должны быть в состоянии `Running`.  
  Причина: Сбой Ingress-контроллера приведет к недоступности сервисов.  

- **TLS-сертификаты Ingress**  
  Проверка: Валидность сертификатов, используемых для маршрутов, за 14 дней до истечения.  

- **HTTP-ошибки Ingress**  
  Проверка: Частота ошибок 5xx в логах Ingress-контроллера.  
  Причина: Проблемы с backend-сервисами или конфигурацией маршрутов.  

---

### **5. Проверка сетевых компонентов**  
- **Доступность CoreDNS**  
  Проверка: Статус подов CoreDNS и успешное разрешение DNS-имен внутри кластера.  
  Причина: Сбой DNS приведет к недоступности сервисов.  

- **Проверка эндпоинтов сервисов**  
  Проверка: Наличие валидных эндпоинтов для критических сервисов (`kubectl get endpoints`).  
  Причина: Отсутствие эндпоинтов указывает на проблемы с подами или Selectors.  

---

### **6. Проверка внешней доступности**  
- **DNS-разрешение доменов**  
  Проверка: Корректное разрешение доменов, используемых для Ingress и API, до VIP LB.  
  Причина: Проблемы с DNS-записями могут привести к недоступности.  

- **SSL/TLS-сертификаты для API и Ingress**  
  Проверка: Валидность сертификатов через `openssl x509 -in <cert> -text -noout`.  

---

### **7. Проверка логов и событий**  
- **Критические события в кластере**  
  Проверка: Наличие событий типа `Warning` или `Error` в `kubectl describe node` или `kubectl describe pod`.  
  Причина: Например, `NodeNotReady`, `EvictedPods`, `CrashLoopBackOff`.  

- **Логи системных компонентов**  
  Проверка: Строки `FATAL`, `ERROR`, `Panic` в логах:  
  - `/var/log/messages` (RHEL/CentOS),  
  - `/var/log/syslog` (Debian/Ubuntu),  
  - Логи kubelet и контейнеров.  

---

### **8. Проверка самой Zabbix**  
- **Доступность Zabbix-агента**  
  Проверка: Статус агента на всех узлах и серверах LB.  

- **Задержка проверок**  
  Проверка: Разница между запланированным и фактическим временем выполнения проверок (>5 минут — алерт).  

---

### **Примеры алертов с приоритетом**  
| Уровень | Метрика                          | Действие                              |  
|---------|----------------------------------|---------------------------------------|  
| Критический | VIP LB недоступен                | Эскалация на команду поддержки        |  
| Критический | kube-apiserver недоступен через LB | Проверка мастер-узлов и LB            |  
| Критический | Сертификат истекает в течение 7 дней | Срочное обновление                   |  
| Предупреждение | Использование диска >80%         | Уведомление о необходимости очистки |  

---

### **Источники**  
- Концепция LoadBalancer в Kubernetes: .  
- Архитектура кластера и компоненты: .  

Этот список позволяет сосредоточиться на критических точках отказа, минимизируя шум, но обеспечивая быстрое реагирование на серьезные инциденты.
