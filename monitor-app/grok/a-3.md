Дашборд мониторинга информационной системы в Grafana
Общие требования

Дашборд содержит по одной Stats Panel для каждого типа компонента ИС.
Статусы компонентов: ok (работает без замечаний), warning (нефатальные ошибки), error (компонент не работает).
Метрики собираются с помощью Prometheus 2.31.
Дашборд отображает совокупный статус каждого компонента на основе собранных метрик.
Период обновления данных: 30 секунд.

Компоненты ИС и их метрики
1. Nginx в DMZ (несколько равнозначных серверов)

Описание: Внешний Nginx в DMZ обрабатывает запросы пользователей из интернета.
Инструмент сбора метрик: Nginx Prometheus Exporter (например, nginx-prometheus-exporter).
Метрики:
nginx_up (1 если Nginx работает, 0 если нет).
nginx_http_requests_total (общее количество обработанных запросов).
nginx_http_request_duration_seconds (время обработки запросов, для выявления аномалий).


Сбор метрик:
Установить nginx-prometheus-exporter на каждом сервере Nginx в DMZ.
Настроить Nginx для экспорта метрик через /metrics (обычно порт 9113).
Настроить Prometheus для скрейпинга метрик с каждого сервера Nginx.


Логика определения статуса:
ok: Все серверы Nginx имеют nginx_up == 1 и среднее время обработки запросов (avg(nginx_http_request_duration_seconds)) ниже порога (например, 1 секунда).
warning: Один или несколько серверов имеют nginx_up == 0, но хотя бы один сервер работает (sum(nginx_up) > 0).
error: Все серверы недоступны (sum(nginx_up) == 0).


PromQL-запрос для Stats Panel:sum(nginx_up{job="nginx_dmz"})


Оформление в Grafana:
Значение > 0 и равно количеству серверов → ok (зелёный).
Значение > 0, но меньше количества серверов → warning (жёлтый).
Значение == 0 → error (красный).





2. Серверы приложений (AS)

Описание: Серверы приложений, на которых запущены микросервисы и внутренний Nginx.
Инструмент сбора метрик: Node Exporter (для состояния серверов) + Application Exporter (если микросервисы экспортируют свои метрики).
Метрики:
up (1 если сервер доступен, 0 если нет, через Node Exporter).
node_cpu_seconds_total (загрузка CPU).
node_memory_MemAvailable_bytes (доступная память).
node_filesystem_avail_bytes (свободное место на диске).


Сбор метрик:
Установить Node Exporter на каждом сервере приложений.
Настроить Prometheus для скрейпинга метрик с Node Exporter (порт 9100).


Логика определения статуса:
ok: Все серверы имеют up == 1, загрузка CPU < 80%, доступная память > 20%, свободное место на диске > 10%.
warning: Один или несколько серверов имеют up == 0, но хотя бы один работает, или превышены пороги по CPU/памяти/диску.
error: Все серверы недоступны (sum(up{job="node_as"}) == 0).


PromQL-запрос для Stats Panel:sum(up{job="node_as"})


Оформление в Grafana:
Значение равно количеству серверов → ok (зелёный).
Значение > 0, но меньше количества серверов → warning (жёлтый).
Значение == 0 → error (красный).





3. Микросервисы

Описание: Микросервисы запущены по одному экземпляру на каждом сервере приложений.
Инструмент сбора метрик: Собственный экспортёр метрик (зависит от языка разработки микросервисов, например, Prometheus Client для Java/Spring, Python, Go и т.д.).
Метрики:
up (1 если микросервис работает, 0 если нет).
http_requests_total (общее количество запросов к микросервису).
http_request_duration_seconds (время обработки запросов).
errors_total (количество ошибок в микросервисе).


Сбор метрик:
Реализовать экспорт метрик в каждом микросервисе (например, через /actuator/prometheus для Spring Boot).
Настроить Prometheus для скрейпинга метрик с каждого микросервиса.


Логика определения статуса:
ok: Все экземпляры микросервиса имеют up == 1, количество ошибок (errors_total) не растёт.
warning: Один или несколько экземпляров недоступны (sum(up{job="microservices"}) > 0), или есть рост errors_total.
error: Все экземпляры недоступны (sum(up{job="microservices"}) == 0).


PromQL-запрос для Stats Panel:sum(up{job="microservices"})


Оформление в Grafana:
Значение равно количеству экземпляров → ok (зелёный).
Значение > 0, но меньше количества экземпляров → warning (жёлтый).
Значение == 0 → error (красный).





4. Внутренний Nginx (маршрутизация на микросервисы)

Описание: Nginx на серверах приложений маршрутизирует запросы к микросервисам.
Инструмент сбора метрик: Nginx Prometheus Exporter.
Метрики:
nginx_up (1 если Nginx работает, 0 если нет).
nginx_http_requests_total (общее количество запросов).
nginx_http_upstream_errors_total (ошибки маршрутизации к микросервисам).


Сбор метрик:
Установить nginx-prometheus-exporter на каждом сервере приложений.
Настроить Prometheus для скрейпинга метрик.


Логика определения статуса:
ok: Все внутренние Nginx имеют nginx_up == 1, ошибок маршрутизации нет.
warning: Один или несколько серверов недоступны, но хотя бы один работает, или есть ошибки маршрутизации.
error: Все серверы недоступны (sum(nginx_up{job="nginx_internal"}) == 0).


PromQL-запрос для Stats Panel:sum(nginx_up{job="nginx_internal"})


Оформление в Grafana:
Значение равно количеству серверов → ok (зелёный).
Значение > 0, но меньше количества серверов → warning (жёлтый).
Значение == 0 → error (красный).





5. Кластер Redis

Описание: Кластер серверов с Redis для кэширования и хранения данных.
Инструмент сбора метрик: Redis Exporter.
Метрики:
redis_up (1 если Redis работает, 0 если нет).
redis_connected_clients (количество подключённых клиентов).
redis_memory_used_bytes (используемая память).


Сбор метрик:
Установить Redis Exporter на каждом сервере Redis.
Настроить Prometheus для скрейпинга метрик (порт 9121).


Логика определения статуса:
ok: Все узлы кластера имеют redis_up == 1, память используется в пределах нормы.
warning: Один или несколько узлов недоступны, но кластер работает (sum(redis_up) > 0).
error: Все узлы недоступны (sum(redis_up) == 0).


PromQL-запрос для Stats Panel:sum(redis_up{job="redis"})


Оформление в Grafana:
Значение равно количеству узлов → ok (зелёный).
Значение > 0, но меньше количества узлов → warning (жёлтый).
Значение == 0 → error (красный).





6. Кластер RabbitMQ

Описание: Кластер RabbitMQ для асинхронного обмена сообщениями.
Инструмент сбора метрик: RabbitMQ Prometheus Exporter.
Метрики:
rabbitmq_up (1 если узел работает, 0 если нет).
rabbitmq_queue_messages (количество сообщений в очередях).
rabbitmq_consumers (количество потребителей).


Сбор метрик:
Включить плагин rabbitmq_prometheus на каждом узле RabbitMQ.
Настроить Prometheus для скрейпинга метрик (порт 15692).


Логика определения статуса:
ok: Все узлы имеют rabbitmq_up == 1, очереди не переполнены.
warning: Один или несколько узлов недоступны, но кластер работает, или очереди переполнены.
error: Все узлы недоступны (sum(rabbitmq_up) == 0).


PromQL-запрос для Stats Panel:sum(rabbitmq_up{job="rabbitmq"})


Оформление в Grafana:
Значение равно количеству узлов → ok (зелёный).
Значение > 0, но меньше количества узлов → warning (жёлтый).
Значение == 0 → error (красный).





7. Кластер Kafka

Описание: Кластер Kafka для обработки потоков данных.
Инструмент сбора метрик: JMX Exporter для Kafka.
Метрики:
kafka_broker_up (1 если брокер работает, 0 если нет).
kafka_controller_active_controller_count (наличие активного контроллера).
kafka_topic_partition_under_replicated (количество недореплицированных партиций).


Сбор метрик:
Установить JMX Exporter на каждом брокере Kafka.
Настроить Prometheus для скрейпинга метрик (порт 7071).


Логика определения статуса:
ok: Все брокеры имеют kafka_broker_up == 1, нет недореплицированных партиций.
warning: Один или несколько брокеров недоступны, или есть недореплицированные партиции.
error: Все брокеры недоступны (sum(kafka_broker_up) == 0).


PromQL-запрос для Stats Panel:sum(kafka_broker_up{job="kafka"})


Оформление в Grafana:
Значение равно количеству брокеров → ok (зелёный).
Значение > 0, но меньше количества брокеров → warning (жёлтый).
Значение == 0 → error (красный).





8. Кластер Postgres

Описание: Кластер серверов с PostgreSQL для хранения данных.
Инструмент сбора метрик: Postgres Exporter.
Метрики:
pg_up (1 если сервер работает, 0 если нет).
pg_stat_activity_count (количество активных подключений).
pg_stat_replication_lag (задержка репликации).


Сбор метрик:
Установить Postgres Exporter на каждом сервере Postgres.
Настроить Prometheus для скрейпинга метрик (порт 9187).


Логика определения статуса:
ok: Все узлы имеют pg_up == 1, задержка репликации минимальна.
warning: Один или несколько узлов недоступны, но кластер работает, или есть задержка репликации.
error: Все узлы недоступны (sum(pg_up) == 0).


PromQL-запрос для Stats Panel:sum(pg_up{job="postgres"})


Оформление в Grafana:
Значение равно количеству узлов → ok (зелёный).
Значение > 0, но меньше количества узлов → warning (жёлтый).
Значение == 0 → error (красный).





9. Кластер Keycloak

Описание: Кластер серверов с Keycloak для управления аутентификацией.
Инструмент сбора метрик: Keycloak Metrics SPI или JMX Exporter.
Метрики:
keycloak_up (1 если узел работает, 0 если нет).
keycloak_request_duration_seconds (время обработки запросов).
keycloak_failed_login_attempts (неуспешные попытки входа).


Сбор метрик:
Настроить Keycloak Metrics SPI или JMX Exporter.
Настроить Prometheus для скрейпинга метрик.


Логика определения статуса:
ok: Все узлы имеют keycloak_up == 1, нет роста неуспешных попыток входа.
warning: Один или несколько узлов недоступны, или есть рост ошибок входа.
error: Все узлы недоступны (sum(keycloak_up) == 0).


PromQL-запрос для Stats Panel:sum(keycloak_up{job="keycloak"})


Оформление в Grafana:
Значение равно количеству узлов → ok (зелёный).
Значение > 0, но меньше количества узлов → warning (жёлтый).
Значение == 0 → error (красный).





10. Кластер Consul

Описание: Кластер серверов с Consul для управления конфигурацией и сервис-дискавери.
Инструмент сбора метрик: Consul Telemetry (встроенный экспорт метрик).
Метрики:
consul_up (1 если узел работает, 0 если нет).
consul_raft_leader (наличие лидера в кластере).
consul_health_node_status (статус здоровья узлов).


Сбор метрик:
Включить телеметрию в Consul (порт 8500/metrics).
Настроить Prometheus для скрейпинга метрик.


Логика определения статуса:
ok: Все узлы имеют consul_up == 1, есть лидер (sum(consul_raft_leader) == 1).
warning: Один или несколько узлов недоступны, но кластер работает.
error: Все узлы недоступны (sum(consul_up) == 0) или нет лидера.


PromQL-запрос для Stats Panel:sum(consul_up{job="consul"})


Оформление в Grafana:
Значение равно количеству узлов → ok (зелёный).
Значение > 0, но меньше количества узлов → warning (жёлтый).
Значение == 0 → error (красный).





Настройка дашборда в Grafana

Создание дашборда:
В Grafana создать новый дашборд с названием, например, "Статус ИС".
Добавить 10 Stats Panel (по одной для каждого компонента).


Настройка панелей:
Для каждой панели указать PromQL-запрос, указанный выше.
Настроить пороговые значения (Thresholds) для цветов:
Зелёный: статус ok.
Жёлтый: статус warning.
Красный: статус error.


Указать название панели (например, "Nginx DMZ", "Redis Cluster" и т.д.).


Визуализация:
Использовать текстовые значения или цветовые индикаторы (например, "OK", "Warning", "Error").
Добавить описание (tooltip) для каждой панели с деталями статуса.


Общие настройки:
Установить период обновления дашборда: 30 секунд.
Настроить datasource на Prometheus (URL сервера Prometheus).



Дополнительные рекомендации

Настроить алерты в Prometheus для уведомления о статусах warning и error.
Для каждого компонента добавить дополнительные панели (например, графики) для детального анализа метрик (опционально).
Проверить доступность всех экспортёров метрик перед настройкой дашборда.
Использовать Consul для автоматического обнаружения сервисов в Prometheus (service discovery).
