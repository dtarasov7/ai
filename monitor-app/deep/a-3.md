### **Дашборд для мониторинга статуса ИС в Grafana**  

**Цель:**  
Отображать общий статус информационной системы (ИС) с помощью **stats-панелей** для каждого типа компонента. Статус каждого компонента определяется как:  
- **OK** – работает без замечаний  
- **Warning** – есть нефатальные ошибки (например, часть серверов недоступна)  
- **Error** – компонент полностью неработоспособен  

---

## **1. Метрики и правила определения статуса для каждого компонента**  

### **1.1. Nginx в DMZ**  
**Метрики:**  
- Доступность (`up`) каждого экземпляра (через **Prometheus Blackbox Exporter** или **nginx_status**).  
- HTTP-коды ответов (5xx ошибки).  

**Правила статуса:**  
- **OK**: Все серверы `up=1`, нет 5xx ошибок.  
- **Warning**: Хотя бы один сервер `up=0` или есть 5xx ошибки.  
- **Error**: Все серверы `up=0`.  

**PromQL:**  
```promql
sum(up{job="nginx_dmz"}) by (instance)  # Проверка доступности
sum(rate(nginx_http_requests_total{status=~"5.."}[5m])) by (instance)  # Ошибки 5xx
```

---

### **1.2. Сервера приложений (AS) и микросервисы**  
**Метрики:**  
- Доступность (`up`) серверов (через **Node Exporter**).  
- Доступность микросервисов (HTTP-проверка или **Spring Boot Actuator**).  
- Ошибки в логах (если используется **Loki** или **ELK**).  

**Правила статуса:**  
- **OK**: Все серверы `up=1`, микросервисы отвечают.  
- **Warning**: Часть серверов `up=0` или микросервисы возвращают ошибки.  
- **Error**: Все серверы `up=0` или микросервисы не отвечают.  

**PromQL:**  
```promql
sum(up{job="app_servers"}) by (instance)  # Доступность серверов
sum(rate(http_requests_total{status=~"5..",service=~"microservice_.*"}[5m]))  # Ошибки микросервисов
```

---

### **1.3. Redis**  
**Метрики:**  
- Доступность (`redis_up`).  
- Количество подключенных реплик (`redis_connected_slaves`).  
- Использование памяти (`redis_memory_used_bytes`).  

**Правила статуса:**  
- **OK**: Все ноды `up=1`, реплики синхронизированы.  
- **Warning**: Часть нод `up=0` или реплики отстают.  
- **Error**: Все ноды `up=0` или Redis не отвечает.  

**PromQL:**  
```promql
sum(redis_up) by (instance)  # Доступность
sum(redis_connected_slaves) by (instance)  # Реплики
```

---

### **1.4. RabbitMQ**  
**Метрики:**  
- Доступность (`rabbitmq_up`).  
- Количество очередей (`rabbitmq_queues`).  
- Сообщения в режиме ожидания (`rabbitmq_messages_ready`).  

**Правила статуса:**  
- **OK**: Все ноды `up=1`, нет забитых очередей.  
- **Warning**: Часть нод `up=0` или есть очереди с большим числом сообщений.  
- **Error**: Все ноды `up=0` или RabbitMQ не отвечает.  

**PromQL:**  
```promql
sum(rabbitmq_up) by (instance)  # Доступность
sum(rabbitmq_messages_ready > 1000) by (queue)  # Переполненные очереди
```

---

### **1.5. Kafka**  
**Метрики:**  
- Доступность (`kafka_server_up`).  
- Количество брокеров (`kafka_brokers`).  
- Лаги потребителей (`kafka_consumer_lag`).  

**Правила статуса:**  
- **OK**: Все брокеры `up=1`, лаги в норме.  
- **Warning**: Часть брокеров `up=0` или есть большие лаги.  
- **Error**: Все брокеры `up=0` или Kafka не отвечает.  

**PromQL:**  
```promql
sum(kafka_server_up) by (instance)  # Доступность
sum(kafka_consumer_lag > 1000) by (topic)  # Большие лаги
```

---

### **1.6. PostgreSQL**  
**Метрики:**  
- Доступность (`pg_up`).  
- Репликация (`pg_replication_lag`).  
- Количество активных подключений (`pg_connections`).  

**Правила статуса:**  
- **OK**: Все ноды `up=1`, репликация работает.  
- **Warning**: Часть нод `up=0` или есть отставание реплики.  
- **Error**: Все ноды `up=0` или БД не отвечает.  

**PromQL:**  
```promql
sum(pg_up) by (instance)  # Доступность
sum(pg_replication_lag > 10) by (instance)  # Лаг репликации
```

---

### **1.7. Keycloak**  
**Метрики:**  
- Доступность (`keycloak_up`).  
- Время ответа (`keycloak_request_duration_seconds`).  
- Ошибки аутентификации (`keycloak_failed_login_attempts`).  

**Правила статуса:**  
- **OK**: Все инстансы `up=1`, нет ошибок.  
- **Warning**: Часть инстансов `up=0` или есть ошибки аутентификации.  
- **Error**: Все инстансы `up=0` или Keycloak не отвечает.  

**PromQL:**  
```promql
sum(keycloak_up) by (instance)  # Доступность
sum(rate(keycloak_failed_login_attempts[5m]))  # Ошибки входа
```

---

### **1.8. Consul**  
**Метрики:**  
- Доступность (`consul_up`).  
- Количество нод (`consul_serf_live_members`).  
- Количество проверок (`consul_health_check_status`).  

**Правила статуса:**  
- **OK**: Все ноды `up=1`, нет failed-проверок.  
- **Warning**: Часть нод `up=0` или есть failed-проверки.  
- **Error**: Все ноды `up=0` или Consul не отвечает.  

**PromQL:**  
```promql
sum(consul_up) by (instance)  # Доступность
sum(consul_health_check_status{status="critical"})  # Критические проверки
```

---

## **2. Дашборд в Grafana**  
**Структура:**  
- **Общий статус ИС** (сводная панель, агрегирующая статусы всех компонентов).  
- **Stats-панели** для каждого компонента (цвета: зелёный=OK, жёлтый=Warning, красный=Error).  
- **Дополнительные графики** (по желанию) для детализации проблем.  

**Пример PromQL для сводного статуса:**  
```promql
# Агрегированный статус (можно использовать метрики типа `component_status{component="nginx_dmz"}`)
```

### **Итог**  
Дашборд даст **быстрый визуальный индикатор** состояния ИС, позволяя оперативно реагировать на проблемы.
