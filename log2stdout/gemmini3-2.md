Для решения вашей задачи необходимо настроить взаимодействие между systemd, rsyslog и Vector, а также гарантировать надежную буферизацию.

Ниже рассмотрены два основных архитектурных подхода. В обоих случаях **ключевым моментом** является настройка `rsyslog` таким образом, чтобы он обрабатывал логи сервисов `Abc*` особым образом (отправлял на srv1 и останавливал обработку, чтобы не писать в `/var/log/messages`).

---

### Общая часть: Защита от потери данных (Disk Buffers)

Независимо от выбранного варианта маршрутизации, требование пережить **часы простоя Kafka** и **аварийную перезагрузку** решается на стороне **Vector** с помощью механизма **Disk Buffers**.

В конфигурации `sink` (kafka) в Vector необходимо включить буферизацию на диске. Это сохранит данные на жестком диске хоста, если Kafka недоступна или если Vector/сервер перезагружаются.

**Пример настройки буфера в Vector (`vector.yaml`):**

```yaml
data_dir: "/var/lib/vector" # Важно: путь должен быть персистентным

sinks:
  to_kafka:
    type: "kafka"
    inputs: ["my_source_id"]
    bootstrap_servers: "broker:9092"
    topic: "logs-topic"
    encoding:
      codec: "json"
    # НАСТРОЙКА НАДЕЖНОСТИ
    buffer:
      type: "disk"             # Пишем на диск, а не в RAM
      max_size: 10737418240    # Например, 10 ГБ (хватит на часы/дни)
      when_full: "block_on_write" # Блокировать чтение, если место кончилось (или drop_newest)
```

---

### Вариант 1: Параллельное чтение (Рекомендуемый)

В этом варианте и Rsyslog, и Vector читают журнал systemd (journald) независимо друг от друга.
*   **Rsyslog:** Читает журнал -> фильтрует `Abc` -> шлет на `srv1` -> **STOP** (не пишет в messages).
*   **Vector:** Читает журнал (только `Abc`) -> Disk Buffer -> Kafka.

#### Настройка Rsyslog
Создайте файл `/etc/rsyslog.d/10-abc-services.conf`. Важно, чтобы имя файла начиналось с малого числа (например, 00, 10), чтобы эти правила сработали **до** стандартной записи в `/var/log/messages`.

```conf
# /etc/rsyslog.d/10-abc-services.conf

# Фильтр по имени программы (systemd передает имя сервиса или executable)
# Если имя начинается на Abc
if $programname startswith 'Abc' then {
    # 1. Отправляем на syslog сервер srv1 (согласно ТЗ)
    action(type="omfwd" target="srv1" port="514" protocol="udp")

    # 2. Останавливаем дальнейшую обработку для этих логов.
    # Это ГАРАНТИРУЕТ, что они не попадут в /var/log/messages (который обрабатывается позже)
    stop
}
```

#### Настройка Vector
Vector читает данные напрямую из journald. Это самый быстрый и надежный способ получения метаданных.

```yaml
sources:
  abc_journal:
    type: "journald"
    # Фильтруем юниты на входе. Systemd unit обычно заканчивается на .service
    # Можно использовать wildcard
    include_units: ["Abc*.service"] 

sinks:
  to_kafka:
    type: "kafka"
    inputs: ["abc_journal"]
    # ... настройки kafka и disk buffer (см. выше) ...
```

#### Плюсы и минусы Варианта 1

| Характеристика | Оценка |
| :--- | :--- |
| **Надежность** | **Высокая**. Если Rsyslog зависнет, Vector продолжит писать в Kafka. Если Vector упадет, Rsyslog продолжит писать на srv1. |
| **Производительность** | **Высокая**. Vector читает бинарный журнал, минуя парсинг syslog-сообщений. |
| **Сложность** | Низкая. Четкое разделение ответственности. |
| **Метаданные** | Vector получает все поля systemd (PID, UID, container_id и т.д.) без лишних усилий. |

---

### Вариант 2: Rsyslog как единый маршрутизатор (Chained)

В этом варианте Rsyslog читает журнал, отправляет данные на `srv1`, пересылает их в Vector (по локальному TCP/UDP) и затем отбрасывает их, чтобы не писать в файл.

#### Настройка Rsyslog (`/etc/rsyslog.d/10-abc-services.conf`)

```conf
if $programname startswith 'Abc' then {
    # 1. Отправляем на внешний syslog srv1
    action(type="omfwd" target="srv1" port="514" protocol="udp")
    
    # 2. Отправляем в Vector на локальный порт
    action(type="omfwd" target="127.0.0.1" port="9000" protocol="tcp" template="RSYSLOG_SyslogProtocol23Format")
    
    # 3. Stop - не пишем в /var/log/messages
    stop
}
```

#### Настройка Vector

```yaml
sources:
  from_rsyslog:
    type: "syslog"
    address: "127.0.0.1:9000"
    mode: "tcp"

sinks:
  to_kafka:
    type: "kafka"
    inputs: ["from_rsyslog"]
    # ... настройки kafka и disk buffer ...
```

#### Плюсы и минусы Варианта 2

| Характеристика | Оценка |
| :--- | :--- |
| **Централизация** | Логика маршрутизации сосредоточена в одном месте (rsyslog). |
| **Надежность** | Средняя. Если Rsyslog встанет колом (например, заблокируется очередь `imjournal`), логи перестанут идти и в Kafka тоже. |
| **Формат логов** | Хуже. Vector получит уже сформированную syslog-строку. Часть метаданных systemd может потеряться или потребует дополнительного парсинга в Vector. |
| **Производительность** | Ниже. Двойная сериализация/десериализация (Systemd -> Rsyslog -> TCP -> Vector). |

---

### Итоговое сравнение и рекомендация

| Критерий | Вариант 1 (Параллельный) | Вариант 2 (Через Rsyslog) |
| :--- | :--- | :--- |
| **Защита /var/log/messages** | Реализуется через `stop` в rsyslog (одинаково). | Реализуется через `stop` в rsyslog (одинаково). |
| **Доставка в srv1** | Через Rsyslog. | Через Rsyslog. |
| **Доставка в Kafka** | Напрямую Vector -> Kafka. | Rsyslog -> Vector -> Kafka. |
| **Буферизация (Crash safety)** | Vector Disk Buffer. | Vector Disk Buffer (+ очереди Rsyslog). |
| **Зависимости** | Процессы независимы. | Vector зависит от здоровья Rsyslog. |

**Рекомендация:** Используйте **Вариант 1**.

1.  Он более современный («cloud-native» подход сбора логов напрямую из источника).
2.  Он надежнее: проблема с `rsyslog` (который часто бывает перегружен или блокируется при проблемах сети с `srv1`) не повлияет на доставку критичных бизнес-логов в Kafka.
3.  Vector эффективнее работает с `journald` напрямую, предоставляя более богатый набор полей для аналитики.

**Резюме действий:**
1.  В **Vector**: Source `journald` (include units Abc*), Sink `kafka` с `buffer.type: disk`.
2.  В **Rsyslog**: Конфиг с приоритетом (например, 10-abc.conf), где `if $programname startswith 'Abc'` -> отправить на srv1 -> `stop`.
