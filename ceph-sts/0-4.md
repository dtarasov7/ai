Ниже — минимальный рабочий пример Python для **Ceph RGW STS**: берём готовый JWT (например access token от Keycloak) и вызываем `AssumeRoleWithWebIdentity` через boto3, указывая `endpoint_url` на ваш RGW (`https://ceph`). Ceph в документации STS приводит ровно такой же паттерн: `boto3.client('sts', endpoint_url=<STS URL>)` → `assume_role_with_web_identity(...)` → временные креды для S3.[1][2]

```python
#!/usr/bin/env python3
import boto3

RGW_ENDPOINT = "https://ceph"

ROLE_ARN = "arn:aws:iam:::role/role-group1"   # роль в RGW
ROLE_SESSION_NAME = "user1"                  # попадёт в audit/ops-логи как имя сессии
WEB_IDENTITY_JWT = "<PASTE_KEYCLOAK_ACCESS_TOKEN_HERE>"

sts = boto3.client(
    "sts",
    endpoint_url=RGW_ENDPOINT,
    region_name="",  # для RGW обычно оставляют пустым, как в примерах Ceph
)

resp = sts.assume_role_with_web_identity(
    RoleArn=ROLE_ARN,
    RoleSessionName=ROLE_SESSION_NAME,
    DurationSeconds=3600,
    WebIdentityToken=WEB_IDENTITY_JWT,
)

creds = resp["Credentials"]
print("AccessKeyId:", creds["AccessKeyId"])
print("SecretAccessKey:", creds["SecretAccessKey"])
print("SessionToken:", creds["SessionToken"])

# пример: сразу использовать временные креды в S3
s3 = boto3.client(
    "s3",
    endpoint_url=RGW_ENDPOINT,
    region_name="",
    aws_access_key_id=creds["AccessKeyId"],
    aws_secret_access_key=creds["SecretAccessKey"],
    aws_session_token=creds["SessionToken"],
)

print(s3.list_buckets())
```

Что важно для успеха вызова:
- В RGW должен быть создан OIDC provider, и trust policy роли должна пропускать ваш JWT (например по `aud` и `groups`).[2]
- JWT должен быть валидным и не истёкшим; иначе `AssumeRoleWithWebIdentity` вернёт отказ.[1]

Если нужен вариант без “вставить JWT руками” (получение JWT из Keycloak по password grant прямо в этом же скрипте) — можно прислать ваши `KEYCLOAK_URL` и “confidential vs public” для client `ceph-s3`, и будет один файл end-to-end.[3]

[1](https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/sts/client/assume_role_with_web_identity.html)
[2](https://docs.ceph.com/en/quincy/radosgw/STS/)
[3](https://github.com/keycloak/keycloak/discussions/22472)
[4](https://docs.ceph.com/en/latest/radosgw/STS/)
[5](https://ceph.io/en/news/blog/2025/rgw-modernizing-sts/)
[6](https://www.ibm.com/docs/en/storage-ceph/7.1.0?topic=developer-examples-using-secure-token-service-apis)
[7](https://docs.redhat.com/en/documentation/red_hat_ceph_storage/4/html/developer_guide/examples-using-the-secure-token-service-apis_dev)
[8](https://boto3.amazonaws.com/v1/documentation/api/latest/guide/credentials.html)
[9](https://github.com/boto/boto3/issues/2258)
[10](https://github.com/OSNEXUS/KeyCloak-w-Ceph-RADOSGW)
[11](https://github.com/ceph/ceph/blob/main/doc/radosgw/keycloak.rst)
[12](https://docs.ceph.com/en/latest/radosgw/session-tags/)
[13](https://docs.aws.amazon.com/code-library/latest/ug/python_3_sts_code_examples.html)
[14](https://forum.proxmox.com/threads/ceph-radosgw-user-management-and-sts.146069/)
[15](https://docs.redhat.com/documentation/red_hat_ceph_storage/8/html/developer_guide/examples-using-the-secure-token-service-apis_dev)
[16](https://stackoverflow.com/questions/65420090/how-to-config-ceph-rgw-sts-key)
[17](https://docs.ceph.com/en/latest/radosgw/role/)
[18](https://www.spinics.net/lists/ceph-users/msg69879.html)
[19](https://archive.fosdem.org/2020/schedule/event/sds_ceph_sts_in_object_storage/attachments/slides/3930/export/events/attachments/sds_ceph_sts_in_object_storage/slides/3930/STS_in_Ceph)
[20](https://github.com/ceph/ceph/blob/main/src/rgw/rgw_auth.h)
[21](https://www.reddit.com/r/ceph_storage/comments/1pk4j3y/release_radosgwassume_cli_tool_for_oidc/)
