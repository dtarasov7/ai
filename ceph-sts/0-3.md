Проверка делается в 2 шага: (1) убедиться, что JWT от Keycloak реально содержит `groups`, (2) вызвать `AssumeRoleWithWebIdentity` на **RGW STS** с этим JWT и затем выполнить S3-операции временными ключами (и увидеть `AccessDenied` там, где запрещено). В Ceph документации STS прямо описан этот поток: приложение получает web token у OIDC IdP и вызывает `AssumeRoleWithWebIdentity`, получая временные S3 credentials для дальнейших S3 запросов.[1][2]

## 1) Bash: взять JWT и проверить claim groups

```bash
KC_URL="https://keycloak"
REALM="test"
CLIENT_ID="ceph-s3"
CLIENT_SECRET="<секрет клиента, если confidential>"
USER="user1"
PASS="Passw0rd!"

TOKEN_JSON=$(
  curl -s "$KC_URL/realms/$REALM/protocol/openid-connect/token" \
    -H 'content-type: application/x-www-form-urlencoded' \
    --data-urlencode "grant_type=password" \
    --data-urlencode "client_id=$CLIENT_ID" \
    --data-urlencode "client_secret=$CLIENT_SECRET" \
    --data-urlencode "username=$USER" \
    --data-urlencode "password=$PASS"
)

JWT=$(echo "$TOKEN_JSON" | jq -r .access_token)

# Показать groups из payload (без проверки подписи; только для теста)
python3 - <<'PY'
import base64, json, os
jwt = os.environ["JWT"]
payload = jwt.split(".")[1] + "==="
data = base64.urlsafe_b64decode(payload).decode()
obj = json.loads(data)
print("groups:", obj.get("groups"))
print("aud   :", obj.get("aud"))
print("iss   :", obj.get("iss"))
PY
```

Ожидаете `groups: ['/group1']` для `user1` (по нашему mapper’у full-path).[3]

## 2) Python: JWT → STS → S3 (фактическое тестирование прав)

Ниже — минимальный тест именно “в Ceph RGW”: берём JWT по паролю из Keycloak, вызываем `AssumeRoleWithWebIdentity` на `https://ceph`, получаем временные ключи и делаем S3 операции. `AssumeRoleWithWebIdentity` и сама идея “получить временные креды и затем идти в S3” — базовый STS-паттерн, который Ceph RGW поддерживает.[4][2]

```python
#!/usr/bin/env python3
import requests
import boto3
from botocore.exceptions import ClientError

KEYCLOAK = "https://keycloak"
REALM = "test"
CLIENT_ID = "ceph-s3"
CLIENT_SECRET = "<секрет клиента, если confidential>"

RGW_ENDPOINT = "https://ceph"

ROLE_GROUP1 = "arn:aws:iam:::role/role-group1"
ROLE_GROUP2 = "arn:aws:iam:::role/role-group2"

def get_jwt(username, password):
    url = f"{KEYCLOAK}/realms/{REALM}/protocol/openid-connect/token"
    data = {
        "grant_type": "password",
        "client_id": CLIENT_ID,
        "username": username,
        "password": password,
    }
    # для confidential client добавляем secret
    if CLIENT_SECRET and CLIENT_SECRET != "<секрет клиента, если confidential>":
        data["client_secret"] = CLIENT_SECRET

    r = requests.post(url, data=data, timeout=15)
    r.raise_for_status()
    return r.json()["access_token"]

def assume(role_arn, jwt, session_name):
    sts = boto3.client("sts", endpoint_url=RGW_ENDPOINT, region_name="")
    resp = sts.assume_role_with_web_identity(
        RoleArn=role_arn,
        RoleSessionName=session_name,
        WebIdentityToken=jwt,
        DurationSeconds=3600,
    )
    c = resp["Credentials"]
    return c["AccessKeyId"], c["SecretAccessKey"], c["SessionToken"]

def s3_client(ak, sk, token):
    return boto3.client(
        "s3",
        endpoint_url=RGW_ENDPOINT,
        region_name="",
        aws_access_key_id=ak,
        aws_secret_access_key=sk,
        aws_session_token=token,
    )

def ok_or_denied(desc, fn):
    try:
        fn()
        print(f"OK  : {desc}")
    except ClientError as e:
        code = e.response.get("Error", {}).get("Code")
        print(f"FAIL: {desc} -> {code}")

def test(username, password, role_arn):
    jwt = get_jwt(username, password)
    ak, sk, st = assume(role_arn, jwt, session_name=username)
    s3 = s3_client(ak, sk, st)

    ok_or_denied(f"{username}: list b1", lambda: s3.list_objects_v2(Bucket="b1"))
    ok_or_denied(f"{username}: put b1/x.txt", lambda: s3.put_object(Bucket="b1", Key="x.txt", Body=b"data"))

    ok_or_denied(f"{username}: list b2", lambda: s3.list_objects_v2(Bucket="b2"))
    ok_or_denied(f"{username}: put b2/x.txt", lambda: s3.put_object(Bucket="b2", Key="x.txt", Body=b"data"))

if __name__ == "__main__":
    # user1 (group1) должен уметь b1 и не уметь b2
    test("user1", "Passw0rd!", ROLE_GROUP1)

    # user2 (group2) должен уметь b2 и не уметь b1
    test("user2", "Passw0rd!", ROLE_GROUP2)
```

## Если AssumeRoleWithWebIdentity не проходит

Почти всегда причина одна из этих:
- В JWT нет `groups` или формат не тот (`/group1` vs `group1`).[3]
- Trust policy роли в RGW сравнивает не тот claim (например `aud` vs `azp`) или не тот issuer-prefix в ключах условия. В Ceph STS указано, что условия trust policy строятся на claims JWT.[2]

Если пришлёте пример decoded payload access token (без подписи/секретов) и ваш trust policy для роли — можно точно сказать, какое поле сравнивать и как правильно назвать ключ в `Condition`.

[1](https://docs.ceph.com/en/latest/radosgw/keycloak/)
[2](https://docs.ceph.com/en/quincy/radosgw/STS/)
[3](https://www.keycloak.org/docs-api/latest/javadocs/org/keycloak/protocol/oidc/mappers/GroupMembershipMapper.html)
[4](https://docs.ceph.com/en/pacific/radosgw/STS/)
[5](https://docs.ceph.com/en/latest/radosgw/STS/)
[6](https://community.ibm.com/community/user/security/blogs/deepak-thorat/2024/03/20/ceph-ISV-integration-using-Open-ID-Connect)
[7](https://ceph.io/en/news/blog/2025/rgw-rate-limiting/)
[8](https://fig.io/manual/aws/sts/assume-role-with-web-identity)
[9](https://wiki.ymlnet.com/ceph/radosgw/keycloak/)
[10](https://boto3.amazonaws.com/v1/documentation/api/1.26.83/reference/services/sts/client/assume_role_with_web_identity.html)
[11](https://docs.redhat.com/en/documentation/red_hat_ceph_storage/7/html/developer_guide/examples-using-the-secure-token-service-apis_dev)
[12](https://docs.redhat.com/en/documentation/red_hat_ceph_storage/4/html/object_gateway_configuration_and_administration_guide/rgw-administration-rgw)
[13](https://docs.aws.amazon.com/STS/latest/APIReference/API_AssumeRoleWithWebIdentity.html)
[14](https://docs.redhat.com/en/documentation/red_hat_ceph_storage/4/html/developer_guide/examples-using-the-secure-token-service-apis_dev)
[15](https://stackoverflow.com/questions/65420090/how-to-config-ceph-rgw-sts-key)
[16](https://docs.aws.amazon.com/cli/latest/reference/sts/assume-role-with-web-identity.html)
[17](https://github.com/OSNEXUS/KeyCloak-w-Ceph-RADOSGW)
[18](https://github.com/grafana/loki/issues/8014)
[19](https://awscli.amazonaws.com/v2/documentation/api/2.1.29/reference/sts/assume-role-with-web-identity.html)
[20](https://github.com/ceph/ceph/blob/main/doc/radosgw/keycloak.rst)
[21](https://docs.redhat.com/en/documentation/red_hat_ceph_storage/6/html-single/developer_guide/index)
