Ниже — минимальный набор команд для “чистого” Keycloak **v25** через `kcadm.sh`: создать realm `test`, client `ceph-s3`, группы `group1/group2`, пользователей `user1/user2` и добавить пользователей в группы. `kcadm.sh` — штатный Admin CLI Keycloak для управления realm/users/groups/clients через Admin REST API.[1][2]

> Предполагается, что Keycloak доступен как `https://keycloak` и у вас есть админ в `master` (например `admin/admin`). Если URL/учётка другие — замените.

## 1) Логин в kcadm

```bash
export KC_URL="https://keycloak"
export KC_BIN="/opt/keycloak/bin/kcadm.sh"

$KC_BIN config credentials \
  --server "$KC_URL" \
  --realm master \
  --user admin \
  --password admin
```

`kcadm.sh config credentials` используется для аутентификации CLI в Keycloak Admin API.[2][1]

## 2) Создать realm test

```bash
$KC_BIN create realms -s realm=test -s enabled=true
```

Создание realm выполняется через endpoint `realms` Admin API, что делает и `kcadm.sh create realms`.[1][2]

## 3) Создать группы group1 и group2

```bash
$KC_BIN create groups -r test -s name=group1
$KC_BIN create groups -r test -s name=group2
```

Операции с группами выполняются через Admin CLI “Group operations”, включая создание групп.[3][1]

## 4) Создать пользователей user1 и user2 + пароль

```bash
$KC_BIN create users -r test -s username=user1 -s enabled=true
$KC_BIN create users -r test -s username=user2 -s enabled=true

$KC_BIN set-password -r test --username user1 --new-password 'Passw0rd!' --temporary=false
$KC_BIN set-password -r test --username user2 --new-password 'Passw0rd!' --temporary=false
```

`kcadm.sh` поддерживает операции управления пользователями, включая создание и установку пароля.[3][1]

## 5) Добавить пользователей в группы

Получаем ID пользователей и групп и выполняем “join user to a group” через `update users/<uid>/groups/<gid>`. Этот способ прямо описан в документации по Admin CLI.[3]

```bash
U1_ID=$($KC_BIN get users -r test -q username=user1 --fields id --format csv | tail -n1)
U2_ID=$($KC_BIN get users -r test -q username=user2 --fields id --format csv | tail -n1)

G1_ID=$($KC_BIN get groups -r test -q search=group1 --fields id,name --format csv | awk -F, '$2=="group1"{print $1}' | head -n1)
G2_ID=$($KC_BIN get groups -r test -q search=group2 --fields id,name --format csv | awk -F, '$2=="group2"{print $1}' | head -n1)

$KC_BIN update "users/$U1_ID/groups/$G1_ID" -r test -s realm=test
$KC_BIN update "users/$U2_ID/groups/$G2_ID" -r test -s realm=test
```

## 6) Создать OIDC client ceph-s3 (confidential)

Для схемы с STS обычно удобнее confidential client. Команда создаёт client с `clientId=ceph-s3` и включённой “client authentication” (то есть confidential).[1]

```bash
$KC_BIN create clients -r test \
  -s clientId=ceph-s3 \
  -s protocol=openid-connect \
  -s publicClient=false \
  -s 'redirectUris=["*"]' \
  -s directAccessGrantsEnabled=true \
  -s standardFlowEnabled=true \
  -s serviceAccountsEnabled=false \
  -s enabled=true
```

Если вам нужен **password grant** для получения JWT в тестовом скрипте (как вы спрашивали ранее), параметр `directAccessGrantsEnabled=true` как раз включает Direct Access Grants на клиенте.[4]

## 7) (Опционально) Включить claim groups в token

В Keycloak обычно нужно добавить “Group Membership” mapper, чтобы claim `groups` попадал в access token. Это делается через protocol mappers OIDC; с точки зрения RGW дальше вы сможете проверять этот claim в trust policy роли.[5][1]

Если скажете, какой формат groups вам нужен (`["group1"]` vs `["/group1"]`) и в какой токен класть (access token vs ID token), подготовлю конкретные `kcadm.sh create protocol-mappers/models ...` команды под Keycloak v25.

[1](https://www.keycloak.org/docs/latest/server_admin/index.html)
[2](https://www.keycloak.org/docs-api/latest/rest-api/index.html)
[3](https://wjw465150.gitbooks.io/keycloak-documentation/content/server_admin/topics/admin-cli.html)
[4](https://www.keycloak.org/securing-apps/oidc-layers)
[5](https://docs.ceph.com/en/latest/radosgw/STS/)
[6](https://stackoverflow.com/questions/56743109/keycloak-create-admin-user-in-a-realm)
[7](https://www.keycloak.org/server/importExport)
[8](https://docs.redhat.com/en/documentation/red_hat_build_of_keycloak/26.2/html/server_administration_guide/admin_cli)
[9](https://kanidm.github.io/kanidm/master/integrations/oauth2/examples.html)
[10](https://stackoverflow.com/questions/67887490/is-there-a-way-to-add-a-user-to-several-groups-in-bulk-in-keycloak-using-keycl)
[11](https://docs.redhat.com/en/documentation/red_hat_build_of_keycloak/22.0/html/server_administration_guide/admin_cli)
[12](https://www.lydtechconsulting.com/blog/oauth-oidc-part3)
[13](https://cray-hpe.github.io/docs-csm/en-13/operations/security_and_authentication/keycloak_user_management_with_kcadm/)
[14](https://www.keycloak.org/2024/06/keycloak-2500-released)
[15](https://www.devsecopsnow.com/keycloak-client-scopes-mappers-step%E2%80%91by%E2%80%91step-hands%E2%80%91on-tutorial/)
[16](https://www.ibm.com/docs/en/gdsc/3.x?topic=configuring-keycloak)
[17](https://www.youtube.com/watch?v=xlD6l1p2Vag&vl=it)
[18](https://www.devopsschool.com/blog/keycloak-keycloak-and-kc-sh-command-complete-guide/)
[19](https://docs.redhat.com/en/documentation/red_hat_single_sign-on/7.3/html/server_administration_guide/the_admin_cli)
[20](https://docs.redhat.com/de/documentation/red_hat_build_of_keycloak/22.0/html/server_administration_guide/admin_cli)
[21](https://stackoverflow.com/questions/53118828/keycloak-public-client-and-authorization)
