Для теста с Ceph RGW STS (v17) проще и надёжнее выбрать: **claim `groups` в access token**, формат — **full path** (`["/group1"]`, `["/group2"]`). Так меньше шансов на коллизии имён (если появятся вложенные группы) и это стандартное поведение “Group Membership” mapper в Keycloak.[1][2]

Ниже — команды `kcadm.sh`, которые добавляют mapper “Group Membership” к вашему client `ceph-s3`, чтобы claim `groups` попадал в **access token**.

## 1) Узнать internal id клиента ceph-s3

`kcadm` работает с client по полю `id` (UUID), поэтому сначала получаем его:[3]

```bash
export KC_URL="https://keycloak"
export KC_BIN="/opt/keycloak/bin/kcadm.sh"

CID=$($KC_BIN get clients -r test -q clientId=ceph-s3 --fields id --format csv | tail -n1)
echo "$CID"
```

## 2) Добавить protocol mapper “Group Membership” в access token

Создаём protocol mapper на клиенте: endpoint `clients/<id>/protocol-mappers/models`.[4][5]

```bash
$KC_BIN create "clients/$CID/protocol-mappers/models" -r test \
  -s name="groups" \
  -s protocol="openid-connect" \
  -s protocolMapper="oidc-group-membership-mapper" \
  -s 'config."claim.name"="groups"' \
  -s 'config."full.path"="true"' \
  -s 'config."access.token.claim"="true"' \
  -s 'config."id.token.claim"="false"' \
  -s 'config."userinfo.token.claim"="false"'
```

Что это даёт:
- В access token появляется claim `groups`.[2]
- Значения будут в виде путей: `/group1`, `/group2` (т.к. `full.path=true`).[1]

## 3) Быстрая проверка (получить токен и посмотреть groups)

Если у клиента `ceph-s3` включён Direct Access Grants (password grant), можно получить access token по паролю и проверить claim `groups`. (Сама возможность класть группы в access token зависит от mapper, который мы добавили выше.)[2][1]

Пример запроса:

```bash
curl -s "$KC_URL/realms/test/protocol/openid-connect/token" \
  -d grant_type=password \
  -d client_id=ceph-s3 \
  -d username=user1 \
  -d password='Passw0rd!' | jq -r .access_token | jwt decode -
```

В decoded payload ожидается что-то вроде:

```json
"groups": ["/group1"]
```

## 4) Что поменять в Ceph trust policy (важно)

Раз вы выбрали full path, в trust policy роли для group1/group2 нужно сравнивать именно с `"/group1"` и `"/group2"`, а не `"group1"`. Это критично, иначе `AssumeRoleWithWebIdentity` будет отклонён.[6][1]

Если хотите — можно наоборот сделать `full.path=false`, тогда claim будет `["group1"]` (короче), но для теста “как есть” full path обычно предсказуемее.[1]

[1](https://www.keycloak.org/docs-api/latest/javadocs/org/keycloak/protocol/oidc/mappers/GroupMembershipMapper.html)
[2](https://groups.google.com/g/keycloak-user/c/J7gIs2vw3S0)
[3](https://groups.google.com/g/keycloak-user/c/UZVz0Jqic_M)
[4](https://lists.jboss.org/pipermail/keycloak-user/2018-August/014985.html)
[5](https://wjw465150.gitbooks.io/keycloak-documentation/content/server_admin/topics/admin-cli.html)
[6](https://docs.ceph.com/en/latest/radosgw/STS/)
[7](https://stackoverflow.com/questions/62202266/include-groups-along-with-roles-in-keycloak-token)
[8](https://infisical.com/docs/documentation/platform/sso/keycloak-oidc/group-membership-mapping)
[9](https://larsolino.com/2025/01/15/keycloak-groups/)
[10](https://github.com/keycloak/keycloak/discussions/13646)
[11](https://shaaf.dev/keycloak-tutorial/6-usergroups/)
[12](https://www.keycloak.org/docs/latest/server_admin/index.html)
[13](https://github.com/keycloak/keycloak/discussions/19055)
[14](https://github.com/keycloak/keycloak/issues/22340)
[15](https://stackoverflow.com/questions/56362197/keycloak-oidc-retrieve-user-groups-attributes)
[16](https://yandex.cloud/en/docs/tutorials/security/keycloak)
[17](https://stackoverflow.com/questions/60552007/create-protocol-mapper-in-keycloak-using-kcadm-sh)
[18](https://github.com/keycloak/keycloak/issues/12950)
[19](https://stackoverflow.com/questions/77454168/mapping-user-groups-to-jwt-in-keycloak-maps-realm-roles-instead)
[20](https://github.com/keycloak/keycloak/issues/29878)
[21](https://wjw465150.gitbooks.io/keycloak-documentation/content/server_admin/topics/groups.html)
[22](https://github.com/keycloak/keycloak/discussions/32364)
