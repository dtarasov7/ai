# Компоненты системы RAG

## Обзор ключевых компонентов
- Три основных этапа
  - Индексация
  - Извлечение
  - Генерация
- Практические аспекты разработки
  - Создание промтов
  - Определение LLM
  - Пользовательский интерфейс
  - Компонент оценки

## 1. Индексация
### Характеристики этапа
- Предварительная обработка в автономном режиме
- Выполняется до взаимодействия пользователя
- Первый основной этап RAG

### Загрузка данных
- WebBaseLoader для веб-документов
- PDF документы
- Word документы
- Неструктурированные данные
- Компонент Documents

### Разбиение текста (Splitting)
#### Типы сплиттеров
- SemanticChunker
  - Семантическое разбиение
- RecursiveCharacterTextSplitter
  - chunk_size: 1000
  - chunk_overlap: 200

#### Токенизация
- Байтовая парная кодировка (BPE)
- Максимум OpenAI: 8191 токенов
- ~4 символа = 1 токен (английский)
- Перекрытие блоков
  - Сохранение контекста
  - Предотвращение потери данных

### Векторизация
#### Векторное хранилище
- Chroma DB
- Альтернативные базы данных

#### Алгоритмы встраивания
- OpenAIEmbeddings()
- Другие алгоритмы векторизации
- Стоимость: $0.10 за 1 млн токенов

#### Создание ретривера
- vectorstore.as_retriever()
- Готов к приему запросов
- Ожидает пользовательского ввода

## 2. Извлечение (Retrieval)
### Процесс извлечения
- Работает в режиме реального времени
- Активируется запросом пользователя

### Компоненты
#### Ретривер
- Поиск сходства
- Векторный поиск в хранилище
- Сопоставление с запросом пользователя

#### Преобразование запроса
- Автоматическая векторизация запроса
- Использование OpenAIEmbeddings()
- Измерение расстояния до векторов

#### Постобработка
- format_docs функция
- Преобразование списка в строку
- Форматирование контекста

### Выходные данные
- {context}: отформатированный контент
- {question}: RunnablePassthrough()
- Список релевантных фрагментов

## 3. Генерация (Generation)
### Создание промтов
#### LangChain Hub
- Обнаружение готовых промтов
- Контроль версий
- Обмен между пользователями

#### Структура промта
- input_variables
  - context
  - question
- HumanMessagePromptTemplate
- PromptTemplate
- Заполнители {question} и {context}
- Шаблон строки с инструкциями

#### Пример шаблона
- Роль: ассистент для ответов
- Инструкция: использовать контекст
- Формат: Question → Context → Answer

### Определение LLM
#### Выбор модели
- ChatOpenAI
- model_name: "gpt-4o"
- temperature: 0

#### Сравнение моделей
- GPT-4o: знает о RAG
- GPT-3.5: дата отсечения январь 2022
- Важность актуальных данных

#### Интеграция в цепочку
- Получает промт на входе
- Генерирует ответ
- Возвращает JSON-формат

### Обработка вывода
- StrOutputParser()
- Преобразование в строку
- Удаление служебной информации
- Финальное форматирование

## 4. Пользовательский интерфейс (UI)
### Функции UI
- Точка взаимодействия пользователя
- Ввод запросов
- Отображение результатов

### Компоненты NLP/NLU
- Natural Language Understanding
- Natural Language Processing
- Интерпретация намерений
- Обработка запросов

### Предварительная обработка
- Форматирование запроса
- Подготовка для LLM
- Работа за кулисами

### Постобработка
- Обработка ответа LLM
- StrOutputParser()
- Форматирование для пользователя

### Интерфейс вывода
#### Дизайн
- Удобное отображение
- Простота взаимодействия
- Пример: ChatGPT интерфейс

#### Дополнительные функции
- Уточнение запросов
- Дополнительные вопросы
- Исходные документы
- Сбор обратной связи

## 5. Оценка (Evaluation)
### Цели оценки
- Повышение эффективности
- Улучшение функций
- Удовлетворение потребностей пользователей

### Метрики
- Точность
- Релевантность
- Время отклика
- Удовлетворенность пользователей

### Типы обратной связи
#### Качественная
- Формы с открытыми вопросами
- Детальные отзывы

#### Количественная
- Верно/неверно
- Рейтинги
- Числовые представления
- Большой палец вверх/вниз

### Использование данных
- Анализ выходных данных
- Определение областей улучшения
- Изменения в дизайне системы
- Оптимизация обработки данных
- Улучшение интеграции LLM

### Непрерывное улучшение
- Постоянная оценка
- Анализ взаимодействий
- Совершенствование векторного поиска
- Повышение качества ответов

## Цепочка RAG (rag_chain)
### Структура цепочки
1. Извлечение
   - retriever | format_docs
   - RunnablePassthrough()
2. Промт
   - Заполнение шаблона
3. LLM
   - Генерация ответа
4. StrOutputParser()
   - Финальная обработка

### Инициация
- rag_chain.invoke(query)
- Последовательное выполнение
- Передача данных между этапами

## Технологии и инструменты
### Фреймворки
- LangChain
- LangChain Hub

### Векторные базы данных
- Chroma DB
- Альтернативные хранилища

### API и модели
- OpenAI API
  - GPT-4o
  - GPT-3.5
  - Embeddings API

### Загрузчики
- WebBaseLoader
- Document loaders
- PDF/Word обработка
