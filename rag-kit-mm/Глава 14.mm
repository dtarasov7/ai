# Глава 14. Продвинутые техники RAG

## Наивный RAG и его ограничения

### Базовый подход
- Извлечение фрагментированных частей контекста
- Векторизация текстовых блоков
- Передача в контекстное окно LLM

### Проблемы
- Сильная фрагментация при малом размере блоков
- Ухудшение понимания текста и семантики
- Только семантический поиск
- Снижение эффективности поиска
- Менее точная генерация

## Гибридный RAG / Мультивекторный RAG

### Концепция
- Использование нескольких векторов
- Комбинация разных типов поиска
- Анализ разных аспектов запроса

### Типы поиска
- Семантический поиск
- Поиск по ключевым словам
- Другие векторные техники

### Применение
- Техническая документация
- Научные исследования
- Корпоративные базы знаний
- Системы вопрос-ответ
- Слабый контекст (имена, коды, аббревиатуры)

## Переранжирование (Re-ranking)

### Процесс
- После семантического и keyword поиска
- Учет результатов обоих поисков
- Учет первоначального рейтинга
- Формирование финального рейтинга

## Лаборатория 14.1: Расширение запроса (Query Expansion)

### Суть метода
- Добавление к запросу дополнительных ключевых слов
- Улучшение понимания запроса
- Увеличение вероятности нахождения документов

### Преимущества
- Улучшает поиск
- Улучшает генерацию
- Добавляет контекст
- Лучшее исходное представление

### Реализация
- Отправка запроса в LLM без RAG-контекста
- Генерация начального ответа (hypothetical_answer)
- Объединение с исходным запросом (joint_query)
- Передача в RAG-конвейер

### Компоненты промтов
- ChatPromptTemplate
- HumanMessagePromptTemplate
- SystemMessagePromptTemplate

### Особенности
- LLM используется на этапе извлечения
- Инженерия промтов важна уже при поиске
- Гипотетический ответ обогащает запрос

## Лаборатория 14.2: Декомпозиция запроса (Query Decomposition)

### Концепция
- Разбиение исходного вопроса на подвопросы
- Обработка последовательно или параллельно
- Консолидация результатов
- Более широкий охват

### Ключевые методы

#### Chain-of-thought (CoT)
- Имитация человеческого логического мышления
- Улучшение работы в задачах логики
- Помощь в вычислениях и принятии решений

#### Interleaving retrieval (IR-CoT)
- Чередование поиска и CoT-промтов
- Получение релевантных данных на каждом этапе
- Динамический процесс поиска

### Процесс работы
- Разбиение на подвопросы (5 вариантов)
- Поиск по первому вопросу
- Формирование ответа
- Новый поиск с учетом предыдущих данных
- Повторение для всех подзапросов

### Реализация
- prompt_decompose для генерации вариантов
- decompose_queries_chain для обработки
- ensemble_retriever.map() для поиска
- format_retrieved_docs для обработки результатов
- Удаление дубликатов (100 → 67 документов)

### Преимущества
- Значительно больше документов
- Лучшее покрытие темы
- Более детальные ответы

## Лаборатория 14.3: Мультимодальный RAG (MM-RAG)

### Мультимодальность

#### Определение
- Работа с несколькими формами информации
- Текст, изображения, видео, аудио
- Входные и выходные данные

#### Примеры
- Текст → Изображение
- Изображение → Текст (генерация подписей)
- Комбинации: текст + изображение → видео + аудио

### Преимущества
- Более содержательные результаты
- Расширение контекста
- Повышение взаимодействия
- Улучшенные диалоговые агенты
- Продвинутые инструменты создания контента

### Мультимодальные эмбеддинги
- Векторизация разных типов данных
- Векторное пространство для всех модальностей
- Модальная независимость
- Схожие концепции близки в векторном пространстве

### Изображения в бизнесе
- Диаграммы
- Схемы
- Инфографика
- Текстовые документы в графическом формате

### Этапы реализации

#### 1. Извлечение данных
- Использование unstructured для PDF
- Извлечение текста и изображений
- OCR для распознавания текста

#### 2. Генерация описаний
- Мультимодальный LLM (GPT-4o-mini)
- Текстовые описания изображений
- Base64-кодирование изображений

#### 3. Векторизация и поиск
- Векторизация описаний
- Поиск по описаниям и текстам
- Мультимодальный векторный поиск

#### 4. Хранение в Chroma
- Тексты
- Изображения (base64)
- Описания изображений

#### 5. Финальная генерация
- Передача текстов и изображений в LLM
- Формирование мультимодального ответа

### Технические компоненты

#### Библиотеки
- unstructured[pdf] - извлечение из PDF
- pillow - работа с изображениями
- pydantic - валидация данных
- lxml - парсинг XML/HTML
- matplotlib - визуализация
- tiktoken - токенизация
- poppler-utils - работа с PDF
- tesseract-ocr - OCR

#### LangChain компоненты
- MultiVectorRetriever
- UnstructuredPDFLoader
- RunnableLambda
- InMemoryStore
- HumanMessage

### Параметры UnstructuredPDFLoader
- mode="elements" - извлечение отдельных элементов
- strategy="hi_res" - высокое качество
- extract_image_block_types - типы изображений
- extract_image_block_to_payload - base64 конвертация

### Хранилища

#### VectorStore (Chroma)
- Хранение эмбеддингов
- Поиск по схожести
- Коллекция mm_rag_google_environmental

#### DocStore (InMemoryStore)
- Хранение фактического контента
- Пары ключ-значение
- Связь через doc_id

### Функции обработки
- apply_prompt() - промт для изображения
- split_image_text_types() - разделение данных
- img_prompt_func() - создание промта
- add_documents() - добавление в хранилища
- plt_img_base64() - отображение изображений

### Конвейер MM-RAG
1. retriever_multi_vector - поиск документов
2. RunnableLambda(split_image_text_types) - разделение
3. RunnableLambda(img_prompt_func) - создание промта
4. llm - обработка мультимодального промта
5. str_output_parser - парсинг результата

## Другие продвинутые методы RAG

### Улучшение индексирования

#### Глубокое разбиение (Deep chunking)
- Использование глубинных нейросетей
- Трансформеры для разбиения
- Оптимальное и интеллектуальное разбиение

#### Адаптеры эмбеддингов
- Облегченные модули
- Адаптация под конкретные задачи
- Без полного дообучения
- Лучшая интерпретация запросов

#### Многоаспектное индексирование
- Создание резюме документов
- Оптимизация под поиск

#### RAPTOR (Рекурсивная абстрактивная обработка)
- Обработка низкоуровневых вопросов
- Обработка высокоуровневых вопросов
- Древовидные структуры обобщений
- Кластеризация и суммаризация
- Иерархия смысловых представлений

#### ColBERT
- Детализированные эмбеддинги
- Сравнение каждого слова с запросом
- Точное семантическое соответствие
- Сохранение нюансов

### Улучшение извлечения (Retrieval)

#### HyDE (Гипотетические эмбеддинги)
- Генерация гипотетического документа
- Эмбеддинг гипотетического документа
- Поиск по индексу

#### Sentence-window retrieval
- Поиск по отдельным предложениям
- Расширение окна вокруг найденного
- Создание полного контекста

#### Auto-merging retrieval
- Решение проблемы фрагментации
- Автоматическое объединение мелких фрагментов
- Улучшение связности контекста

#### Multi-query rewriting
- Переформулирование вопроса
- Поиск по каждому варианту
- Объединение результатов
- Исключение дублей

#### Query translation step-back
- Генерация более общего вопроса
- Создание основы для ответа
- Использование CoT
- Предварительное знание предмета

#### Query structuring
- Преобразование текста в DSL
- Автоматический перевод в SQL
- Структурированные запросы

### Постобработка поиска и генерации

#### Cross-encoder re-ranking
- Детальный анализ документов
- Пересортировка по релевантности
- Более качественный ответ

#### RAG-fusion query rewriting
- Переформулирование запросов
- Поиск по вариантам
- Объединение и ранжирование результатов

### Конвейер RAG в целом

#### Саморефлексивный RAG с LangGraph
- Механизм саморефлексии
- Лингвистическая графовая структура
- Глубокое понимание контекста
- Уточнение ответов
- Детальный анализ взаимосвязей

#### Модульный RAG
- Сменные компоненты
- Гибкая архитектура
- Адаптация к различным задачам
- Экспериментирование с компонентами
- LangChain поддержка
- Настраиваемая система

## Ресурсы для изучения

### Источники новых методов
- Arxiv.org
- Научные статьи
- Оригинальные исследования

### Ключевые термины поиска
- RAG
- Генерация, дополненная поиском
- Векторный поиск
- Retrieval Augmented Generation

## Практические результаты

### Сравнение методов
- Наивный RAG - базовый уровень
- Гибридный RAG - улучшенный поиск
- Query Expansion - расширенный контекст
- Query Decomposition - широкий охват (67 документов)
- MM-RAG - мультимодальные возможности

### Применение в бизнесе
- Техническая документация
- Корпоративные базы знаний
- Диалоговые агенты
- Создание контента
- Системы вопросов и ответов
- Анализ документов с изображениями
