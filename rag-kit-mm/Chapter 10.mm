# Глава 10: Ключевые компоненты RAG в LangChain

## Введение
- Три основных компонента
  - Хранилища векторов
  - Ретриверы (извлекатели)
  - Большие языковые модели (LLMs)
- Цель: улучшение системы RAG через выбор компонентов

## 1. Векторные хранилища

### Роль и назначение
- Эффективное хранение векторных представлений
- Индексирование документов базы знаний
- Унифицированный интерфейс LangChain

### Chroma
#### Характеристики
- Открытая ИИ-ориентированная база данных
- Высокая скорость поиска
- Простота использования
#### Преимущества
- Удобный API
- Динамическая фильтрация по метаданным
- Встроенное разбиение на фрагменты
#### Режимы развертывания
- Хранение в памяти
- Постоянное хранилище
- Контейнеризация (Docker)
#### Архитектура
- Слой индексации
- Слой хранения
- Слой обработки
#### Расширенные методы
- MMR (Максимальная предельная релевантность)
- Фильтрация по метаданным

### FAISS
#### Общая информация
- Библиотека от Facebook AI
- Открытый исходный код
- Высокопроизводительный поиск
#### Возможности
- Обработка больших наборов данных
- Не помещающихся в память
- Различные методы индексации
  - Кластеризация
  - Квантизация
#### Версии
- CPU версия (faiss-cpu)
- GPU версия (faiss-gpu)
  - Значительное ускорение
  - Параллельная обработка
#### Интеграция
- Простая замена Chroma
- Удаление параметров collection_name и client
- Сериализация/десериализация индексов

### Weaviate
#### Особенности
- Встраиваемый режим (Embedded)
- Влияние GraphQL
- RESTful API
- Предопределенные типы данных
#### Преимущества
- Пакетные операции
- Строгая проверка схемы
- Больше контроля над БД
#### Настройка
- Определение схемы класса
- Свойства и типы данных
- Резервирование параметра id
- Использование doc_id вместо id
#### Развертывание
- Встроенный режим
- Отдельный сервер
- Облачное решение

### Сравнение хранилищ
#### Chroma
- Простота и гибкость
- Легкое встраивание
- Фокус на эмбеддингах
#### Weaviate
- Структурированное решение
- Явное определение схемы
- Поддержка нескольких типов хранилищ
#### FAISS
- Производительность
- Масштабируемость
- Настраиваемость
#### Критерии выбора
- Гибкость схемы данных
- Предпочтения развертывания
- Дополнительные функции

## 2. Ретриверы

### Роль в RAG
- Выполнение запросов к векторному хранилищу
- Извлечение релевантных документов
- Интеграция с различными хранилищами

### Базовый ретривер (плотные эмбеддинги)
#### Характеристики
- Использование vectorstore.as_retriever
- Параметр k для количества результатов
- Обертка вокруг векторного хранилища
#### Методы поиска
- Поиск по сходству
  - Косинусное расстояние
  - Евклидово расстояние
- Легкая смена хранилища

### Извлечение по пороговому значению
- Тип: similarity_score_threshold
- Параметр score_threshold
- Фильтрация по уровню сходства
- Улучшение стандартного поиска

### MMR (Maximal Marginal Relevance)
#### Назначение
- Баланс релевантности и разнообразия
- Предотвращение избыточности
- Применение в суммаризации
#### Настройка
- Параметр search_type="mmr"
- Поддержка векторными хранилищами
- Использование в любых ретриверах

### BM25 Ретривер
#### Характеристики
- Функция ранжирования
- Разреженный текстовый поиск
- Реализация в LangChain
#### Принцип работы
- Оценка релевантности документа
- Частота терминов (TF-IDF)
- Вероятностная модель
- Возврат top-k документов

### Комбинированный ретривер (Ensemble)
#### Назначение
- Объединение нескольких методов
- Гибридный поиск
- Плотный + разреженный
#### Параметры
- Список ретриверов
- Веса для каждого (weights)
- Параметр c (повторное ранжирование)
  - c=0: без повторного ранжирования
  - c≠0: дополнительный этап ранжирования
- Параметр k
#### Преимущества
- Семантическое сходство (плотный)
- Совпадение ключевых слов (разреженный)
- Улучшение качества результатов

### Wikipedia Ретривер
#### Характеристики
- Доступ к Wikipedia
- Возврат в формате Document
- Параметр load_max_docs
#### Использование
- Метод get_relevant_documents
- Извлечение метаданных
  - title
  - summary
  - source
- Доступ к page_content

### Специализированные ретриверы
#### PubMedRetriever
- Научные исследования
- Медицинская литература
#### ArxivRetriever
- Математика и информатика
- 2+ миллиона статей
#### KayAiRetriever
- Финансовая сфера
- Отчетность SEC
- Финансовые отчеты компаний

### kNN-ретривер
#### Преимущества kNN vs ANN
- Более точный поиск
- Лучшие результаты для небольших данных
- Алгоритм 1951 года все еще эффективен
#### Ограничения
- Масштабируемость
- Не для крупных предприятий
- Зависит от объема данных
#### Рекомендации использования
- < 1 миллиона точек данных
- Векторы размерности 1536
- Мощная среда разработки
- Переход на ANN при замедлении
#### Реализация
- KNNRetriever.from_texts
- Использование плотных эмбеддингов
- Замена dense_retriever

### Дополнительные ретриверы
#### Time-weighted ретривер
- Учет актуальности данных
- Временное взвешивание
#### Long-Context Reorder
- Работа с длинным контекстом
- Фокус на середине документов
- Улучшение работы моделей

## 3. Большие языковые модели (LLMs)

### Роль LLM в RAG
#### Синергия с RAG
- Дополнение друг друга
- RAG расширяет возможности LLM
- LLM улучшает работу RAG
#### Функции
- Глубокое понимание контекста
- Фактически точные ответы
- Актуальная информация
- Связный результат

### OpenAI
#### Установка и настройка
- Пакет langchain-openai
- Библиотека openai
- Классы ChatOpenAI и OpenAIEmbeddings
#### API ключ
- Файл env.txt
- Переменная окружения OPENAI_API_KEY
- Безопасное хранение
#### Модели
- gpt-4o-mini
  - Новейшая модель
  - Высокая производительность
  - Экономичность
- gpt-3.5-turbo
  - В 10 раз дешевле 4o-mini
  - Достаточная мощность
- gpt-4-32k
  - Большое контекстное окно (4x)
  - Медленнее 4o-mini
#### Параметры
- temperature
  - Контроль случайности
  - 0 = детерминированные ответы
- model_name

### Together AI
#### Преимущества
- Удобный для разработчиков
- Доступ к различным моделям
- Конкурентные цены
- $5 бесплатного кредита
#### Установка
- Пакет langchain-together
- TOGETHER_API_KEY
- Класс ChatTogether
#### Доступные модели
- Meta Llama 3 70B
  - $0.90 за 1M токенов
  - Сопоставима с GPT-4
  - Значительно дешевле
- Mixtral (MoE)
  - $1.20 за 1M токенов
  - Mixture of Experts
  - Высокая производительность
#### Более 50 моделей
- Широкий выбор
- Разные характеристики
- Разная стоимость

### Сравнение результатов
#### Llama 3
- Развернутые ответы
- Высокая детализация
- Экономичность
#### Mixtral MoE
- Структурированные ответы
- Организация по ключевым направлениям
- Детальное описание инициатив
#### GPT-4o-mini
- Качественные ответы
- Более высокая стоимость
- Баланс цены и качества

### Расширенные возможности LLM

#### Интерфейс Runnable
- Стандартные методы
- ainvoke, batch, abatch
- stream, astream
- Базовая поддержка

#### Асинхронные вызовы (Async)
- Выполнение в отдельном потоке
- Продолжение работы программы
- Параллельная обработка
- Повышение скорости

#### Потоковая обработка (Stream)
- Iterator / AsyncIterator
- Финальный результат от LLM
- Совместимость с интеграциями
- Не пословный стриминг

#### Пакетная обработка (Batch)
- Обработка нескольких входов
- Синхронный режим
  - Многопоточные вычисления
- Асинхронный режим
  - asyncio.gather
- Параметр max_concurrency
  - Регулировка одновременных задач
  - RunnableConfig

#### Таблица совместимости
- Не все LLM поддерживают все функции
- Подробная таблица в LangChain
- Проверка возможностей модели

## Выводы главы

### Векторные хранилища
- Ключевая роль в RAG
- Множество вариантов
- Выбор зависит от требований
- Легкая замена компонентов

### Ретриверы
- Центральный компонент поиска
- Плотные, разреженные, комбинированные
- Доступ к внешним источникам
- Специализированные решения

### LLM
- "Мозг" системы RAG
- Интеграция с разными провайдерами
- Баланс стоимости и качества
- Расширенные функции обработки

### Преимущества LangChain
- Легкая замена компонентов
- Адаптация к новым технологиям
- Гибкость архитектуры
- Быстрая интеграция решений

### Следующие шаги
- Изучение вспомогательных компонентов
- Поддержка ключевых элементов
- Дальнейшее улучшение RAG-приложений
