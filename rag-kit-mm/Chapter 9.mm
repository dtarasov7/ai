
# Оценка RAG систем

## 1. Зачем нужна оценка

### На этапе создания
- Выявление областей для улучшения
- Оптимизация производительности
- Измерение влияния изменений
- Понимание компромиссов компонентов
  - Векторные хранилища
  - Алгоритмы поиска
  - Модели генерации

### После развертывания
- Обеспечение эффективности
- Мониторинг надежности
- Контроль производительности
- Выявление деградации
  - Устаревание данных
  - Изменение пользовательских запросов
  - Проблемы инфраструктуры

### Обратная связь
- Механизмы для пользователей
- Мониторинг интерфейса
- Время отклика
- Релевантность ответов
- Опросы пользователей
- Анализ логов взаимодействия

## 2. Стандартизированные структуры оценки

### Бенчмарки эмбеддингов
#### MTEB (Massive Text Embedding Benchmark)
- ArguAna - поиск аргументов
- ClimateFEVER - факты о климате
- CQADupstackRetrieval - дублирующие вопросы
- DBPedia - поиск сущностей
- FEVER - проверка фактов
- FiQA2018 - финансовые Q&A
- HotpotQA - многошаговые Q&A
- MSMARCO - ранжирование документов
- NFCorpus - проверка фактов
- NQ - вопросы-ответы
- QuoraRetrieval - дубликаты вопросов
- SCIDOCS - научные документы
- SciFact - научные утверждения
- Touche2020 - поиск аргументов
- TRECCOVID - информация о COVID-19

### Бенчмарки векторного поиска
#### ANN-Benchmarks
- Точность поиска
- Скорость
- Использование памяти
- FAISS
- ANNOY
- HNSW

#### BEIR
- Zero-shot оценка
- Разнородные домены
- MSMARCO
- HotpotQA
- CQADupStack

### Бенчмарки LLM
#### Artificial Analysis Leaderboard
##### Качественные метрики
- Chatbot Arena
- MMLU - знания
- MT Bench - логика

##### Технические метрики
- Пропускная способность (токенов/сек)
- Задержка
- Объем памяти
- Эффективность масштабирования

#### Open LLM Leaderboard
- ARC - научные рассуждения
- HellaSwag - здравый смысл
- MMLU - специфичные домены
- TruthfulQA - правдивость
- WinoGrande - местоимения
- GSM8K - математика

## 3. Эталонные данные

### Назначение
- Идеальные ответы системы
- Контрольная точка производительности
- Количественная оценка подходов
- Выявление областей улучшения

### Методы создания
#### Аннотирование вручную
- Высокое качество
- Трудоемкий процесс
- Затратный метод

#### Экспертные знания
- Специализированные области
- Технические домены
- Генерация по шаблонам
- Правила для создания

#### Краудсорсинг
- Amazon Mechanical Turk
- Figure Eight
- Четкие инструкции
- Контроль качества

#### Синтетические данные
- Дообученные модели
- Методы на основе поиска
- Автоматическая генерация
- Альтернатива при недостатке данных

## 4. Платформа ragas

### Основные компоненты
#### TestsetGenerator
- Генерация синтетических данных
- Пары вопрос-ответ
- Настройка распределения
- Поддержка LangChain/LlamaIndex

#### Типы эволюции вопросов
- Simple - простые вопросы
- Reasoning - требуют рассуждений
- Multi_context - множественные контексты

#### evaluate()
- Запуск оценки
- Набор метрик
- Объект Result
- Анализ производительности

### Метрики оценки

#### Поиск (Retrieval)
##### context_precision
- Соотношение сигнал/шум
- Релевантные элементы сверху
- Диапазон 0-1
- Требует: вопрос, ground_truth, контекст

##### context_recall
- Найдена ли вся информация
- Соответствие эталону
- Диапазон 0-1
- Требует: ground_truth, контекст

##### context_relevancy
- Релевантность найденного
- Вопрос + контексты

##### context_entity_recall
- Полнота сущностей
- Сравнение с ground_truth
- Важно для фактов

#### Генерация (Generation)
##### faithfulness
- Фактическая точность
- Согласованность с контекстом
- Диапазон 0-1
- Требует: ответ, контекст

##### answer_relevancy
- Уместность ответа
- Полнота информации
- Отсутствие избыточности
- Требует: вопрос, контекст, ответ

#### End-to-End оценка
##### answer_correctness
- Точность vs эталон
- Диапазон 0-1
- Требует: ground_truth, ответ

##### answer_similarity
- Семантическое сходство
- Сравнение с эталоном

##### aspect_critique
- Заранее определенные аспекты
- Безопасность
- Корректность
- Бинарный результат

### Настройка LLM в ragas
- embedding_function - эмбеддинги
- llm - основная генерация
- generator_llm - генерация в оценке
- critic_llm - критическая оценка
- Разделение по назначению

### Практическая реализация
#### Установка
- ragas==0.1.20
- tqdm - индикаторы прогресса
- matplotlib - визуализация
- pandas - анализ данных

#### Конвейеры RAG
- rag_chain_similarity - плотные векторы
- rag_chain_hybrid - гибридный поиск
- Сравнение подходов

#### Процесс оценки
- Генерация синтетических данных
- test_size = 10 примеров
- Распределение типов вопросов
- Запуск метрик
- Сохранение результатов

#### Анализ результатов
- Сравнение средних значений
- Визуализация графиков
- Категории по этапам
- CSV для повторного использования

### Инсайты от основателя

#### Генерация данных
- Решение проблемы недостатка
- Широкий спектр вопросов
- Пересмотр сгенерированных данных
- Исключение нерелевантных

#### Метрики обратной связи
- Явные (ошибки)
- Неявные (удовлетворенность)
- Лайки/дизлайки
- Любое взаимодействие

#### Метрики с/без эталона
- Reference metrics - требуют эталон
- Reference-free - без эталона
- Faithfulness - без эталона
- Answer relevance - без эталона
- Важно для развертывания

#### Оценка в production
- Метрики без эталона идеальны
- Отсутствие ground_truth
- Мониторинг в реальном времени

## 5. Дополнительные методы оценки

### BLEU (Bilingual Evaluation Understudy)
- Совпадение n-грамм
- Сравнение с эталоном
- Поверхностное сходство
- Выбор слов и формулировка
- Ограничение: не учитывает семантику

### ROUGE (Recall-Oriented Understudy)
- Фокус на полноте (recall)
- Охват эталона
- Ключевая информация
- Полезно для длинных ответов
- Совпадение информации

### Семантическое сходство
#### Косинусное сходство
- Семантические представления
- Выход за рамки точного совпадения

#### STS (Semantic Textual Similarity)
- Значение и контекст
- Семантическая связность
- Различные формулировки
- Одинаковое значение

### Оценка человеком
#### Критерии качества
- Релевантность вопросу
- Фактическая точность
- Ясность
- Связность

#### Качественная обратная связь
- Уместность тона
- Несоответствия
- Противоречия
- Пользовательский опыт

#### Дополнение метрик
- Всесторонний анализ
- Тонкие нюансы
- Экспертная оценка

### Комбинированный подход
- Множественные методы
- Сильные и слабые стороны
- Целостное представление
- Специфические требования
- Приоритеты приложения
  - Фактическая точность
  - Беглость
  - Связность

## 6. Важные соображения

### Расходы на API
- Множественные вызовы LLM
- Генерация данных
- Запуск метрик
- Пример: $2.5 за 10 примеров + 6 метрик
- Умеренное использование
- Мониторинг затрат

### Размер данных
- Малые наборы - менее надежно
- Больше примеров - выше расходы
- Баланс качества и затрат
- test_size параметр

### Сохранение результатов
- CSV файлы
- Повторное использование
- Избежание перегенерации
- Экономия ресурсов

### Активная разработка
- Частые обновления ragas
- Изменения API
- Проверка документации
- docs.ragas.io
