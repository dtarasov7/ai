Отличная задача! Создание выделенного шлюза на базе VM с OpenVPN — это надежный способ направить трафик определенных устройств в вашей сети через VPN-туннель.

Ниже приведена пошаговая инструкция со всеми необходимыми командами и конфигурационными файлами.

### Общая схема работы:

1.  **Клиентское устройство** (например, 192.168.1.50) отправляет трафик на свой новый шлюз по умолчанию — нашу VM (192.168.1.250).
2.  **VM-шлюз (192.168.1.250)** принимает этот трафик.
3.  С помощью правил файрвола (iptables) VM-шлюз "заворачивает" (транслирует) адрес источника и направляет трафик в OpenVPN-туннель (`tun0`).
4.  Трафик уходит в интернет через VPN-сервер.

***

### Шаг 1: Предварительная подготовка VM

Предполагается, что у вас уже есть VM с установленной ОС Linux (например, Ubuntu Server или Debian).

1.  **Настройте статический IP-адрес для VM.**
    *   IP-адрес: `192.168.1.250`
    *   Маска подсети: `255.255.255.0` (или `/24`)
    *   Шлюз: `192.168.1.1` (адрес вашего основного роутера)
    *   DNS: `192.168.1.1` или любой публичный (например, `8.8.8.8`)

    Это делается в файле `/etc/netplan/01-netcfg.yaml` ( для Ubuntu) или `/etc/network/interfaces` (для Debian).

    **Пример для Netplan (Ubuntu):**
    ```yaml
    # /etc/netplan/01-netcfg.yaml
    network:
      version: 2
      ethernets:
        eth0: # Важно: имя вашего сетевого интерфейса может отличаться (ens18, enp0s3 и т.д.)
          dhcp4: no
          addresses: [192.168.1.250/24]
          gateway4: 192.168.1.1
          nameservers:
            addresses: [8.8.8.8, 1.1.1.1]
    ```
    Примените конфигурацию командой: `sudo netplan apply`.

2.  **Установите OpenVPN и утилиты для работы с сетью.**
    ```bash
sudo apt update
sudo apt install openvpn iptables-persistent -y
```
Во время установки `iptables-persistent` система спросит, нужно ли сохранять текущие правила для IPv4 и IPv6. Согласитесь на оба варианта (выбрав `<Yes>`).

### Шаг 2: Настройка OpenVPN клиента

1.  **Скопируйте ваш `.ovpn` файл** от VPN-провайдера на VM, например, в директорию `/etc/openvpn/client.conf`.
    *   Имя файла важно. Если вы назовете его `client.conf`, то сможете управлять сервисом через `systemctl start openvpn@client`.

2.  **Отредактируйте конфигурационный файл.**
    Ваш файл от провайдера уже содержит почти все необходимое (сервер, сертификаты и т.д.). Убедитесь, что в нем нет или закомментированы строки, которые могут помешать нашей настройке.

    **Пример минимального файла `/etc/openvpn/client.conf`:**
    ```ini
    client
    dev tun
    proto udp # или tcp, в зависимости от вашего провайдера

    # IP и порт вашего VPN-сервера
    remote vpn.server.com 1194

    # Эти строки не дают OpenVPN изменять маршруты в системе.
    # Мы будем управлять маршрутизацией сами с помощью iptables.
    route-noexec

    # Бесконечные попытки переподключения
    resolv-retry infinite
    nobind

    # Права
    persist-key
    persist-tun

    # Шифрование и аутентификация (эти параметры должны соответствовать серверу)
    cipher AES-256-GCM
    auth SHA256

    # Логирование
    verb 3
    status /var/log/openvpn-status.log
    log-append /var/log/openvpn.log

    # Пути к вашим ключам и сертификатам
    # Если они встроены в .ovpn файл, эти строки не нужны.
    # <ca>...</ca>
    # <cert>...</cert>
    # <key>...</key>
    # <tls-auth>...</tls-auth>
    ```
    **Ключевой момент:** `route-noexec`. Эта директива запрещает OpenVPN-клиенту автоматически добавлять маршрут по умолчанию через VPN. Это важно, так как мы будем контролировать маршрутизацию вручную для перенаправляемого трафика.

### Шаг 3: Включение IP-форвардинга

Чтобы VM могла перенаправлять пакеты с одного интерфейса на другой (из `eth0` в `tun0`), нужно разрешить это на уровне ядра.

1.  **Включите форвардинг.**
    Откройте файл `/etc/sysctl.conf`:
    ```bash
    sudo nano /etc/sysctl.conf
    ```
    Найдите и раскомментируйте (или добавьте) строку:
    ```
    net.ipv4.ip_forward=1
    ```

2.  **Примените изменения:**
    ```bash
    sudo sysctl -p
    ```

### Шаг 4: Настройка файрвола (iptables)

Это самая важная часть. Здесь мы настроим NAT (Network Address Translation) и правила пересылки трафика.

*   Предполагаем, что ваш сетевой интерфейс, смотрящий в локальную сеть, — `eth0`.
*   Интерфейс OpenVPN-туннеля — `tun0`.

Вы можете проверить имена интерфейсов командой `ip a`.

**Выполните следующие команды:**
```bash
# 1. Включаем NAT (Masquerading) для всего трафика, уходящего через tun0.
# Это "маскирует" весь трафик от ваших LAN-хостов (192.168.1.x) под IP-адрес VPN-туннеля.
sudo iptables -t nat -A POSTROUTING -o tun0 -j MASQUERADE

# 2. Разрешаем прохождение трафика из локальной сети (eth0) в VPN-туннель (tun0).
sudo iptables -A FORWARD -i eth0 -o tun0 -j ACCEPT

# 3. Разрешаем прохождение ответного трафика из VPN-туннеля обратно в локальную сеть.
# Правило для уже установленных и связанных соединений.
sudo iptables -A FORWARD -i tun0 -o eth0 -m state --state RELATED,ESTABLISHED -j ACCEPT
```

### Шаг 5: Сохранение правил iptables

Чтобы правила не сбросились после перезагрузки, сохраните их с помощью `iptables-persistent`.
```bash
sudo netfilter-persistent save
```
Эта команда сохранит текущие правила IPv4 в файл `/etc/iptables/rules.v4`.

### Шаг 6: Запуск и проверка

1.  **Перезапустите VM**, чтобы убедиться, что все настройки (статический IP, IP-форвардинг, правила iptables) применяются корректно.

2.  **Запустите OpenVPN клиент:**
    ```bash
    sudo systemctl start openvpn@client
    ```

3.  **Проверьте статус:**
    ```bash
    sudo systemctl status openvpn@client
    # Проверьте, появился ли интерфейс tun0
    ip a show tun0
    ```
    Если все в порядке, добавьте сервис в автозагрузку:
    ```bash
    sudo systemctl enable openvpn@client
    ```

### Шаг 7: Настройка клиентских хостов

Теперь на любом устройстве в вашей сети `192.168.1.0/24`, трафик которого вы хотите направить через VPN, нужно изменить шлюз по умолчанию.

*   **Старый шлюз:** `192.168.1.1` (ваш роутер)
*   **Новый шлюз:** `192.168.1.250` (ваша VM)

**Важно:** При смене шлюза DNS-серверы обычно не меняются. Если вы хотите избежать утечек DNS, вам также следует вручную прописать на этих устройствах публичные DNS-серверы (например, `1.1.1.1`, `8.8.8.8`) или DNS-серверы вашего VPN-провайдера.

**Как изменить шлюз (примеры):**

*   **На Windows:**
    1.  Откройте "Панель управления" -> "Центр управления сетями и общим доступом".
    2.  "Изменение параметров адаптера".
    3.  Правой кнопкой по вашему сетевому подключению -> "Свойства".
    4.  Выберите "IP версии 4 (TCP/IPv4)" -> "Свойства".
    5.  В поле "Основной шлюз" введите `192.168.1.250`.
    6.  В поля DNS-серверов введите `1.1.1.1` и `8.8.8.8`.

*   **На Linux (временно, для теста):**
    ```bash
    # Удаляем старый шлюз
    sudo ip route del default
    # Добавляем новый
    sudo ip route add default via 192.168.1.250
    ```

### Финальная проверка

На клиентском устройстве, где вы сменили шлюз, откройте браузер и зайдите на сайт для проверки IP-адреса (например, `ifconfig.me` или `2ip.ru`). Вы должны увидеть IP-адрес вашего VPN-сервера, а не ваш домашний IP.

Если что-то пошло не так, в первую очередь проверяйте логи OpenVPN на VM (`/var/log/openvpn.log`) и правильность правил `iptables -L -v -n`.
