Ниже — рабочий подход для Prometheus v2.49 и Grafana v11 с учетом их возможностей и ограничений, а затем готовый JSON дашборда.

Идея
- История версии во времени: строим для каждой пары (nodename, appname) один ряд в State timeline. Для фиксации смены версии (ведь версия — строковая метка) используем хак с hashmod: суммируем hashmod(app, M) без метки version. Число меняется, когда меняется набор меток (то есть версия), и State timeline покажет смену “состояния”. Версию выводим в тултипе по меткам.
- Таблица “когда поменялась версия + предыдущая версия”: 
  - Находим текущую версию как app{...} (instant query — вернёт только актуальные ряды).
  - Для каждой пары (nodename, appname, version) считаем last_seen = max_over_time(timestamp(app)[$__range_s s]).
  - Берём previous = topk_by(nodename,appname, 1, last_seen_non_current), где last_seen_non_current — то же самое, но исключаем текущую через unless.
  - Джойним текущие и previous, перенося previous.version в метку prev_version, а значение используем как время изменения (момент последнего появления предыдущей версии ≈ момент смены).

Важно
- $__range_s в PromQL-выражениях должен быть достаточно большим, чтобы захватить предыдущую смену версии. Если “не влезет”, то предыдущая версия будет “неизвестна”.
- hashmod работает по набору меток; мы агрегируем without(version), чтобы получить один ряд на (nodename, appname) с числовым состоянием, меняющимся при смене версии.
- Все выражения совместимы с Prometheus 2.49; дашборд — с Grafana 11.

Готовый дашборд (JSON)
- Переменные: datasource (Prometheus), node (label_values), app (label_values)
- Панель 1 (Table): текущая версия, время последней смены, предыдущая версия
- Панель 2 (State timeline): история изменений версии по хостам/приложениям

Замените при необходимости UID/название датасорса в переменной DS_PROM.

```json
{
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "datasource": { "type": "grafana", "uid": "-- Grafana --" },
        "enable": true,
        "hide": true,
        "iconColor": "rgba(0, 211, 255, 1)",
        "name": "Annotations & Alerts",
        "type": "dashboard"
      }
    ]
  },
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 0,
  "id": null,
  "iteration": 1,
  "links": [],
  "liveNow": false,
  "panels": [
    {
      "type": "table",
      "title": "Текущая версия, время последней смены и предыдущая версия",
      "id": 1,
      "gridPos": { "h": 10, "w": 24, "x": 0, "y": 0 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROM}" },
      "targets": [
        {
          "refId": "A",
          "datasource": { "type": "prometheus", "uid": "${DS_PROM}" },
          "instant": true,
          "legendFormat": "{{nodename}} • {{appname}} • {{version}}",
          "expr": "app{nodename=~\"$node\", appname=~\"$app\"}\n  * on (nodename, appname) group_left(prev_version)\n    label_replace(\n      topk by (nodename, appname) (1,\n        max_over_time(\n          timestamp(app{nodename=~\"$node\", appname=~\"$app\"})[${__range_s}s]\n        )\n        unless on (nodename, appname, version)\n          app{nodename=~\"$node\", appname=~\"$app\"}\n      ),\n      \"prev_version\", \"$1\", \"version\", \"(.*)\"\n    )"
        }
      ],
      "options": {
        "showHeader": true,
        "footer": {
          "fields": "",
          "reducer": ["sum"],
          "show": false
        }
      },
      "fieldConfig": {
        "defaults": {
          "custom": {
            "align": "auto",
            "displayMode": "auto",
            "inspect": false
          }
        },
        "overrides": [
          {
            "matcher": { "id": "byName", "options": "Value" },
            "properties": [
              { "id": "displayName", "value": "Время последней смены" },
              { "id": "unit", "value": "time: YYYY-MM-DD HH:mm:ss" }
            ]
          },
          {
            "matcher": { "id": "byName", "options": "nodename" },
            "properties": [{ "id": "displayName", "value": "nodename" }]
          },
          {
            "matcher": { "id": "byName", "options": "appname" },
            "properties": [{ "id": "displayName", "value": "appname" }]
          },
          {
            "matcher": { "id": "byName", "options": "version" },
            "properties": [{ "id": "displayName", "value": "current_version" }]
          },
          {
            "matcher": { "id": "byName", "options": "prev_version" },
            "properties": [{ "id": "displayName", "value": "previous_version" }]
          }
        ]
      },
      "pluginVersion": "11.0.0",
      "transformations": [
        {
          "id": "filterFieldsByName",
          "options": {
            "include": ["nodename", "appname", "version", "prev_version", "Value"]
          }
        }
      ]
    },
    {
      "type": "state-timeline",
      "title": "История изменений версии (по nodename/appname)",
      "id": 2,
      "gridPos": { "h": 13, "w": 24, "x": 0, "y": 10 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROM}" },
      "targets": [
        {
          "refId": "A",
          "datasource": { "type": "prometheus", "uid": "${DS_PROM}" },
          "legendFormat": "{{nodename}} • {{appname}}",
          "expr": "sum without (version) (hashmod(app{nodename=~\"$node\", appname=~\"$app\"}, 1000000))"
        }
      ],
      "options": {
        "mergeValues": true,
        "legend": {
          "displayMode": "list",
          "placement": "bottom"
        },
        "tooltip": {
          "mode": "single",
          "sort": "none"
        },
        "rowHeight": 0.9,
        "showValue": "never" 
      },
      "fieldConfig": {
        "defaults": {
          "unit": "none",
          "custom": {
            "lineWidth": 1,
            "hideFrom": { "legend": false, "tooltip": false, "viz": false }
          }
        },
        "overrides": []
      },
      "pluginVersion": "11.0.0"
    }
  ],
  "refresh": "30s",
  "schemaVersion": 39,
  "style": "dark",
  "tags": ["versions", "state-timeline", "prometheus"],
  "templating": {
    "list": [
      {
        "name": "DS_PROM",
        "type": "datasource",
        "query": "prometheus",
        "hide": 0,
        "current": null,
        "options": []
      },
      {
        "name": "node",
        "label": "nodename",
        "type": "query",
        "datasource": { "type": "prometheus", "uid": "${DS_PROM}" },
        "includeAll": true,
        "multi": true,
        "query": "label_values(app, nodename)",
        "refresh": 2,
        "sort": 1,
        "current": { "selected": true, "text": ["All"], "value": ["$__all"] }
      },
      {
        "name": "app",
        "label": "appname",
        "type": "query",
        "datasource": { "type": "prometheus", "uid": "${DS_PROM}" },
        "includeAll": true,
        "multi": true,
        "query": "label_values(app, appname)",
        "refresh": 2,
        "sort": 1,
        "current": { "selected": true, "text": ["All"], "value": ["$__all"] }
      }
    ]
  },
  "time": { "from": "now-30d", "to": "now" },
  "timepicker": {
    "refresh_intervals": ["5s", "10s", "30s", "1m", "5m", "15m", "1h", "6h", "12h", "24h"],
    "time_options": ["1h", "6h", "12h", "24h", "7d", "30d", "90d"]
  },
  "timezone": "",
  "title": "App versions (Prom v2.49 / Grafana v11)",
  "uid": "app-versions-timeline",
  "version": 1,
  "weekStart": ""
}
```

Пояснения и tips
- Таблица (панель 1)
  - Поле Value — это unix time последнего появления предыдущей версии; в overrides выставлен формат времени.
  - Если “предыдущая версия” отсутствует в выбранном диапазоне времени, строка для такого узла может не появиться. Увеличьте диапазон (например, до 90 дней).
- State timeline (панель 2)
  - Значения — числовые хэши текущего набора меток без version; сегменты меняются при смене версии. Наведите курсор — в тултипе будут метки ряда (nodename, appname), а саму версию можно подсмотреть через отдельный граф/таблицу или добавить вторую скрытую цель с legendFormat: v={{version}} для тултипа. Если хотите видеть текст версии прямо в сегментах, это потребует внешнего маппинга “версия -> число” или логов (Loki); PromQL сам по себе не умеет конвертировать строковые метки в значения.
- Производительность
  - max_over_time(timestamp(app)[$__range_s s]) — не самая тяжёлая операция, но при очень большом диапазоне и большом количестве серий может нагружать Prometheus. При необходимости используйте recording rules.
- Скрейп
  - Для точности времени смены учитывайте шаг скрейпа: фактическая смена произойдёт в интервале [last_seen_prev, first_seen_curr]; в таблице выводится last_seen_prev.

Если нужно, могу добавить ещё панель с “время с последней смены” по каждому узлу/приложению или визуал с подписью версии в самой полосе (через доп. трансформации/маппинг).
