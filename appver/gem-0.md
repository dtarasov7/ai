Отличный вопрос. Создать такую таблицу в Grafana возможно, но это потребует довольно сложного запроса в PromQL, поскольку нам нужно одновременно получить информацию о текущем состоянии и о состоянии в прошлом.

Вот пошаговая инструкция, как это сделать.

### Основная идея запроса (PromQL)

Чтобы найти момент изменения версии и узнать предыдущую версию, нам нужно:
1.  **Найти моменты времени, когда версия изменилась.** Это можно сделать, сравнив метрику `app` с ее же состоянием некоторое время назад (используя модификатор `offset`). Если метрики не равны (потому что метка `version` изменилась), значит, произошло изменение.
2.  **Получить старую версию.** В тот же момент времени, когда мы обнаружили изменение, нам нужно получить значение метки `version` из прошлого (опять же, с помощью `offset`).
3.  **Соединить все в один результат.** Мы используем оператор `group_left`, чтобы к метрике, обозначающей изменение, добавить новую метку `previous_version`, которую мы извлечем из прошлого состояния.

### Шаг 1: Создание панели и PromQL-запроса в Grafana

1.  В вашем дашборде Grafana создайте новую панель (Add panel).
2.  Выберите тип визуализации **Table**.
3.  В редакторе запросов (Query editor) выберите источник данных Prometheus.
4.  Вставьте следующий PromQL-запрос:

    ```promql
    # Основной запрос для таблицы изменений версий
    (
      # Находим серии, где метка version изменилась по сравнению с состоянием 1 минуту назад.
      # Сравнение `!=` сработает, так как изменится хэш серии из-за смены метки.
      app != on(hostname, appname) app offset 1m
    )
    and on(hostname, appname) group_left(previous_version)
    (
      # Берем состояние 1 минуту назад и с помощью label_replace создаем новую метку "previous_version"
      # из значения старой метки "version".
      label_replace(app offset 1m, "previous_version", "$1", "version", "(.*)")
    )
    ```

#### Объяснение запроса:

*   `app != on(hostname, appname) app offset 1m`: Эта часть — ядро нашего детектора изменений. Она возвращает результат (со всеми метками, включая *новую* `version`) только в те моменты времени, когда текущая серия `app` отличается от той, что была 1 минуту назад. Сравнение происходит для серий с одинаковыми `hostname` и `appname`.
*   `label_replace(app offset 1m, "previous_version", "$1", "version", "(.*)")`: Эта часть берет метрику из прошлого (`app offset 1m`) и создает у нее новую метку `previous_version`, копируя в нее значение из существующей метки `version`.
*   `and on(hostname, appname) group_left(previous_version)`: Это оператор соединения. Он берет результаты из левой части (моменты изменений) и для каждой строки находит соответствующую строку в правой части (данные из прошлого с меткой `previous_version`). `group_left(previous_version)` добавляет метку `previous_version` из правой части к результату.

**Важное замечание:** Значение `offset` (в примере `1m`) должно быть как минимум равно вашему интервалу сбора данных (scrape interval) в Prometheus, а лучше — чуть больше. Если Prometheus собирает данные каждые 30 секунд, используйте `1m`. Если каждые 5 минут, используйте `5m` или `6m`.

### Шаг 2: Настройка панели Grafana

После ввода запроса вы получите сырые данные. Чтобы превратить их в красивую и понятную таблицу, нужно применить преобразования (Transformations).

1.  **Перейдите на вкладку "Transform"** под вашим запросом.
2.  **Добавьте преобразование "Filter by name"**:
    *   Выберите поле `Value` и удалите его. Значение этой метрики (вероятно, `1`) нам не нужно.
3.  **Добавьте преобразование "Organize fields"**:
    *   Это позволит вам переименовать и упорядочить столбцы.
    *   Вы можете скрыть ненужные системные метки (например, `__name__`).
    *   Перетащите поля, чтобы установить нужный порядок:
        1.  `Time`
        2.  `hostname`
        3.  `appname`
        4.  `version` (это новая версия)
        5.  `previous_version`
    *   Вы можете переименовать поля для большей наглядности, например:
        *   `Time` -> `Время изменения`
        *   `hostname` -> `Хост`
        *   `appname` -> `Приложение`
        *   `version` -> `Новая версия`
        *   `previous_version` -> `Предыдущая версия`

### Шаг 3: Настройка опций панели

1.  В правой части экрана в настройках панели (Panel options) вы можете настроить внешний вид.
2.  Убедитесь, что в настройках запроса (Query options) в поле **Format** выбрано **Table**.
3.  Временной диапазон в правом верхнем углу Grafana будет определять, за какой период вы увидите изменения. Если вы выберете "Last 7 days", таблица покажет все изменения версий, произошедшие за последнюю неделю.

В результате вы получите таблицу, которая будет выглядеть примерно так:

| Время изменения | Хост | Приложение | Новая версия | Предыдущая версия |
| :--- | :--- | :--- | :--- | :--- |
| 2025-10-09 14:20:00 | server-01.prod | backend-api | 1.5.2 | 1.5.1 |
| 2025-10-09 11:05:00 | server-02.prod | frontend-app | 2.11.0 | 2.10.0 |
| 2025-10-08 18:30:00 | server-01.prod | backend-api | 1.5.1 | 1.4.9 |

Эта таблица будет автоматически обновляться и показывать историю развертываний вашего ПО на всех серверах, предоставляя ценную информацию для анализа и отладки.
