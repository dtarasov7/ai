Конечно! Ниже — обновлённая версия кода, в которой:

- **Каждая 3-я итерация** (`i % 3 == 0`) — ошибка в **`auth-service`** (как раньше),
- **Каждая 5-я итерация** (`i % 5 == 0`), **но не кратная 3**, — ошибка в **`database`**,
- Остальные — успешные трейсы.

Таким образом, ошибки будут возникать **в разных сервисах**, и вы сможете проверить, как OpenSearch Dashboards и Data Prepper обрабатывают ошибки на разных уровнях цепочки вызовов.

---

### ✅ Обновлённый код: ошибки в `auth-service` **или** `database`

```python
import time
from opentelemetry import trace
from opentelemetry.sdk.trace import TracerProvider
from opentelemetry.sdk.trace.export import BatchSpanProcessor
from opentelemetry.exporter.otlp.proto.grpc.trace_exporter import OTLPSpanExporter
from opentelemetry.sdk.resources import Resource, SERVICE_NAME
from opentelemetry.trace import set_span_in_context, StatusCode

# Настройки
OTLP_ENDPOINT = "localhost:4317"
NUM_TRACES = 15  # Увеличим, чтобы увидеть оба типа ошибок

# Создаём общий exporter
exporter = OTLPSpanExporter(endpoint=OTLP_ENDPOINT, insecure=True)

def create_tracer(service_name: str):
    resource = Resource(attributes={SERVICE_NAME: service_name})
    provider = TracerProvider(resource=resource)
    provider.add_span_processor(BatchSpanProcessor(exporter))
    return provider.get_tracer(__name__)

# Создаём трейсеры
frontend_tracer = create_tracer("frontend")
auth_tracer = create_tracer("auth-service")
db_tracer = create_tracer("database")

for i in range(1, NUM_TRACES + 1):
    error_in_auth = (i % 3 == 0)
    error_in_db = (i % 5 == 0) and not error_in_auth  # Только если нет ошибки в auth

    if error_in_auth:
        error_type = "auth"
    elif error_in_db:
        error_type = "database"
    else:
        error_type = "none"

    print(f"Генерация трейса #{i} — ошибка: {error_type}")

    with frontend_tracer.start_as_current_span("GET /login") as root_span:
        root_span.set_attribute("http.method", "GET")
        root_span.set_attribute("http.route", "/login")
        root_span.set_attribute("trace.iteration", i)

        auth_context = trace.set_span_in_context(root_span)

        with auth_tracer.start_span("validate_token", context=auth_context) as auth_span:
            auth_span.set_attribute("auth.type", "jwt")
            
            if error_in_auth:
                # Ошибка на уровне auth-service
                auth_span.set_status(StatusCode.ERROR, "Token validation failed")
                auth_span.record_exception(ValueError("Invalid JWT token"))
                # Не идём дальше — база не вызывается
            else:
                # Auth успешен — вызываем базу
                db_context = trace.set_span_in_context(auth_span)
                with db_tracer.start_span("query_user", context=db_context) as db_span:
                    db_span.set_attribute("db.statement", "SELECT * FROM users WHERE id = ?")
                    db_span.set_attribute("db.system", "postgresql")
                    
                    if error_in_db:
                        # Ошибка при работе с базой
                        db_span.set_status(StatusCode.ERROR, "Database connection timeout")
                        db_span.record_exception(ConnectionError("DB unreachable"))
                        db_span.add_event("DB query failed")
                    else:
                        db_span.add_event("DB query executed")

    time.sleep(0.05)  # Небольшая задержка

print(f"\nСгенерировано {NUM_TRACES} трейсов.")
print("• Ошибки в 'auth-service': каждая 3-я итерация (3, 6, 9, 12, 15...)")
print("• Ошибки в 'database': каждая 5-я, но не кратная 3 (5, 10...)")
```

---

### 🔍 Пример поведения по итерациям:

| Итерация | Ошибка в       | Почему |
|----------|----------------|--------|
| 1        | —              | — |
| 2        | —              | — |
| 3        | `auth-service` | `3 % 3 == 0` |
| 4        | —              | — |
| 5        | `database`     | `5 % 5 == 0` и `5 % 3 != 0` |
| 6        | `auth-service` | `6 % 3 == 0` (приоритет у auth) |
| 9        | `auth-service` | `9 % 3 == 0` |
| 10       | `database`     | `10 % 5 == 0`, но `10 % 3 != 0` |
| 15       | `auth-service` | `15 % 3 == 0` → приоритет, даже если `15 % 5 == 0` |

> 💡 Мы **намеренно даём приоритет `auth`**, потому что в реальности, если auth упал — база не вызывается. Это делает сценарий более реалистичным.

---

### 📊 Что вы увидите в OpenSearch Dashboards:

- **Трейсы с ошибкой в `auth-service`**:  
  - 2 span'а, последний (`auth-service`) — красный, с ошибкой.
- **Трейсы с ошибкой в `database`**:  
  - 3 span'а, последний (`database`) — красный, с ошибкой подключения.
- **Service Map** покажет ошибки как на связи `frontend → auth-service`, так и на `auth-service → database`.

---

### ⚙️ Советы по тестированию

- Увеличьте `NUM_TRACES` до 30, чтобы увидеть больше примеров.
- В OpenSearch выполните поиск по:
  ```json
  status.code: "ERROR"
  ```
  или
  ```json
  resource.attributes.service.name: "database" AND status.code: "ERROR"
  ```

---

Если хочешь, чтобы ошибки были **случайными** (не по модулю), или добавить **логи с ошибками**, — просто скажи!