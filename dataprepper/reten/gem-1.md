Вы можете настроить глубину хранения и количество реплик для индексов с трейсами в OpenSearch, используя конфигурацию стока (sink) `opensearch` в файле `pipelines.yaml` вашего Data Prepper.

Ниже приведены шаги и примеры конфигурации для решения ваших задач.

### 1. Настройка количества реплик

Для кластера из одного узла OpenSearch необходимо установить количество реплик равным `0`. Если этого не сделать, кластер будет находиться в "желтом" состоянии, так как он не сможет разместить реплики.

В конфигурации стока `opensearch` в вашем `pipelines.yaml` добавьте параметр `number_of_replicas` и установите его значение на `0`.

**Пример:**
```yaml
sink:
  - opensearch:
      hosts: ["https://localhost:9200"]
      index_type: "trace-analytics-raw"
      number_of_replicas: 0
      # ... другие параметры, такие как username, password, cert ...
```
Этот параметр переопределит значение по умолчанию, указанное в шаблоне индекса, который использует Data Prepper.

### 2. Настройка глубины хранения (удаление старых индексов)

Глубина хранения управляется с помощью политик ISM (Index State Management) в OpenSearch. Вы можете создать JSON-файл с политикой, которая будет автоматически удалять индексы по истечении определенного срока, а затем указать путь к этому файлу в конфигурации Data Prepper.

#### Шаг 2.1: Создайте файл ISM-политики

Создайте JSON-файл (например, `delete-traces-after-30-days.json`) со следующим содержанием, чтобы удалять индексы старше 30 дней:

```json
{
  "policy": {
    "description": "Удаляет индексы трейсов через 30 дней.",
    "default_state": "hot",
    "states": [
      {
        "name": "hot",
        "actions": [],
        "transitions": [
          {
            "state_name": "delete",
            "conditions": {
              "min_index_age": "30d"
            }
          }
        ]
      },
      {
        "name": "delete",
        "actions": [
          {
            "delete": {}
          }
        ]
      }
    ]
  }
}
```
В этом примере:
*   `min_index_age: "30d"` — это условие для перехода в состояние `delete`. Индекс будет удален, когда его возраст превысит 30 дней.
*   Секция `delete` определяет действие по удалению индекса.

#### Шаг 2.2: Укажите путь к файлу политики в Data Prepper

В конфигурации стока `opensearch` в файле `pipelines.yaml` используйте параметр `ism_policy_file`, чтобы указать абсолютный путь к созданному файлу политики.

### Итоговая конфигурация `pipelines.yaml`

Объединив обе настройки, ваш раздел `sink` в `pipelines.yaml` может выглядеть следующим образом:

```yaml
# ... (source, processor, etc.)
sink:
  - opensearch:
      hosts: ["https://localhost:9200"]
      # Укажите тип индекса для трейсов
      index_type: "trace-analytics-raw"
      # Устанавливаем количество реплик в 0 для кластера из одного узла
      number_of_replicas: 0
      # Указываем путь к файлу с политикой хранения данных
      ism_policy_file: "/path/to/your/config/delete-traces-after-30-days.json"
      # Добавьте параметры аутентификации, если необходимо
      username: "admin"
      password: "admin"
      # Если используете самоподписанный сертификат
      # cert: "/path/to/your/root-ca.pem"
      # insecure: false
```

**Важные замечания:**
*   Параметр `ism_policy_file` наиболее эффективен, когда для типа индекса (`index_type`) нет встроенной политики. Если для `trace-analytics-raw` существует встроенная политика, которая мешает вашей, возможно, потребуется использовать `index_type: custom` и задать собственный шаблон имени индекса.
*   Убедитесь, что Data Prepper имеет права на чтение файла ISM-политики.
*   После применения изменений Data Prepper будет создавать новые индексы с указанными настройками реплик и привязанной политикой ISM. Политика будет применяться к индексам, созданным после ее настройки.
