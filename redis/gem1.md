Вы совершенно правы в своем наблюдении. В Redis Cluster после автоматического аварийного переключения (failover), когда отказавший мастер-узел восстанавливается, он возвращается в кластер в роли реплики (slave) для того узла, который ранее был его репликой и был повышен до мастера. Это стандартное поведение, предназначенное для обеспечения максимальной доступности кластера.

Чтобы вернуть роль мастера на восстановившийся узел, необходимо выполнить процедуру ручного переключения (manual failover). Эта операция выполняется с помощью команды `CLUSTER FAILOVER`, которая должна быть отправлена на узел-реплику, который вы хотите повысить до мастера. В вашем случае, эту команду нужно выполнить на первоначальном мастере, который после восстановления стал репликой.

### Процесс ручного возвращения роли Master

1.  **Восстановленный узел** (бывший мастер) подключается к кластеру как реплика нового мастера.
2.  Вы подключаетесь к этому **восстановленному узлу** (который теперь реплика) с помощью `redis-cli`.
3.  Вы отдаете ему команду `CLUSTER FAILOVER`.
4.  Узел инициирует процесс ручного переключения. Он убеждается, что обработал все данные от текущего мастера, чтобы избежать потери данных, а затем запрашивает у кластера разрешение стать новым мастером.
5.  Текущий мастер понижается до реплики, а ваш восстановленный узел снова становится мастером.

---

### Скрипты на Bash для автоматизации

Ниже приведены примеры скриптов, которые помогут автоматизировать этот процесс.

#### 1. Простой скрипт

Этот скрипт выполняет команду `CLUSTER FAILOVER` на указанном узле без дополнительных проверок.

**`promote_to_master.sh`**
```bash
#!/bin/bash

# Скрипт для возвращения роли Master узлу Redis Cluster.

# Проверяем, что переданы хост и порт
if [ "$#" -ne 2 ]; then
    echo "Использование: $0 <host> <port>"
    echo "Пример: $0 192.168.1.10 6379"
    exit 1
fi

HOST=$1
PORT=$2

echo "Попытка вернуть роль Master узлу ${HOST}:${PORT}..."

# Отправляем команду CLUSTER FAILOVER на узел, который должен стать мастером
redis-cli -h "${HOST}" -p "${PORT}" CLUSTER FAILOVER

# Команда CLUSTER FAILOVER инициирует процесс переключения, но не завершает его синхронно.
# Статус можно проверить через некоторое время командой ROLE или CLUSTER NODES.
echo "Команда CLUSTER FAILOVER отправлена. Проверьте статус узла через несколько секунд."
echo "Пример проверки: redis-cli -h ${HOST} -p ${PORT} ROLE"
```

**Как использовать:**
1.  Сохраните код в файл `promote_to_master.sh`.
2.  Сделайте его исполняемым: `chmod +x promote_to_master.sh`.
3.  Запустите, указав IP-адрес и порт восстановленного узла:
    ```bash
    ./promote_to_master.sh 192.168.1.10 6379
    ```

---

#### 2. Улучшенный скрипт с проверками

Этот скрипт более надежен: он сначала проверяет текущую роль узла и выполняет переключение, только если узел является репликой.

**`restore_master_role.sh`**
```bash
#!/bin/bash

# Улучшенный скрипт для возвращения роли Master узлу Redis Cluster с предварительной проверкой.

# Проверяем, что переданы хост и порт
if [ "$#" -ne 2 ]; then
    echo "Использование: $0 <host> <port>"
    echo "Пример: $0 192.168.1.10 6379"
    exit 1
fi

HOST=$1
PORT=$2
TIMEOUT=5 # Таймаут для redis-cli в секундах

echo "Проверка статуса узла ${HOST}:${PORT}..."

# Получаем текущую роль узла
# Команда ROLE возвращает массив, где первый элемент - это роль (master, slave, sentinel)
CURRENT_ROLE=$(redis-cli -h "${HOST}" -p "${PORT}" --connect-timeout $TIMEOUT ROLE | head -n 1)

# Проверяем, удалось ли получить роль
if [ -z "$CURRENT_ROLE" ]; then
    echo "Ошибка: не удалось подключиться к узлу ${HOST}:${PORT} или получить его роль."
    exit 1
fi

echo "Текущая роль узла: ${CURRENT_ROLE}"

# Выполняем failover, только если узел является репликой ('slave')
if [ "${CURRENT_ROLE}" == "slave" ]; then
    echo "Узел является репликой. Инициирую ручное переключение (manual failover)..."
    
    # Отправляем команду CLUSTER FAILOVER
    RESULT=$(redis-cli -h "${HOST}" -p "${PORT}" CLUSTER FAILOVER)
    
    if [ "$RESULT" == "OK" ]; then
        echo "Команда CLUSTER FAILOVER успешно отправлена."
        echo "Ожидание 5 секунд для завершения процесса..."
        sleep 5
        
        # Проверяем новую роль
        NEW_ROLE=$(redis-cli -h "${HOST}" -p "${PORT}" ROLE | head -n 1)
        echo "Новая роль узла ${HOST}:${PORT}: ${NEW_ROLE}"
        
        if [ "$NEW_ROLE" == "master" ]; then
            echo "Успех! Узел ${HOST}:${PORT} теперь является Master."
        else
            echo "Предупреждение: узел не стал мастером. Проверьте логи Redis."
        fi
    else
        echo "Ошибка: команда CLUSTER FAILOVER не была выполнена успешно. Ответ Redis: ${RESULT}"
        exit 1
    fi
elif [ "${CURRENT_ROLE}" == "master" ]; then
    echo "Узел уже является Master. Никаких действий не требуется."
else
    echo "Роль узла (${CURRENT_ROLE}) не 'slave'. Скрипт завершает работу."
fi

exit 0
```

**Как использовать:**
Использование аналогично простому скрипту. Этот вариант предпочтительнее, так как он предотвращает лишние действия и предоставляет более подробную обратную связь.

> **Важно:** Перед использованием любых скриптов в производственной среде настоятельно рекомендуется протестировать их в тестовом или staging-окружении, чтобы убедиться, что они работают так, как ожидается.
