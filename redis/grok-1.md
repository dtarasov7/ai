В Redis Cluster версии 6 OSS (Open Source Software) стандартное поведение после автоматического failover (когда один master выходит из строя, и его slave автоматически повышается до master) заключается в том, что восстановленный узел (бывший master) подключается обратно как slave к новому master. Это обеспечивает стабильность кластера и минимизирует риск потери данных. Чтобы автоматически или вручную вернуть роль master на восстановленный узел, необходимо инициировать ручной failover (manual failover) с помощью команды `CLUSTER FAILOVER`. Эта команда отправляется на восстановленный узел (теперь slave), который синхронизирует данные с текущим master и затем запрашивает у кластера разрешение стать новым master. Текущий master (бывший slave) при этом понизится до slave.

### Важные замечания перед использованием
- **Автоматизация**: Redis Cluster не имеет встроенной опции для автоматического возврата роли master на предпочтительный узел (например, по ID или приоритету). Для полной автоматизации можно интегрировать скрипты в систему мониторинга (например, с помощью cron, systemd или инструментов вроде Ansible/Chef), но это требует осторожности, чтобы избежать циклов failover.
- **Предположения**: Узлы кластера настроены с репликацией (replication), и все порты (по умолчанию 6379 для Redis, 16379 для bus) открыты. Скрипты предполагают, что `redis-cli` установлен и доступен.
- **Риски**: Manual failover может вызвать кратковременное прерывание (downtime в миллисекунды), но в production рекомендуется тестировать на staging-окружении. Убедитесь, что кластер здоров (проверьте `CLUSTER INFO` и `CLUSTER NODES`).
- **Проверка роли**: Используйте `redis-cli -h <host> -p <port> ROLE` (возвращает "master" или "slave") или `INFO replication` для мониторинга.

### Процесс ручного возврата роли Master
1. Восстановите и запустите сервис Redis на узле.
2. Подключитесь к этому узлу как к slave.
3. Выполните `CLUSTER FAILOVER` на нём — он станет master, а текущий master понизится.
4. Проверьте статус кластера: `redis-cli -h <any-node> -p <port> CLUSTER NODES`.

### Bash-скрипты для автоматизации
Ниже приведены два примера скриптов на Bash. Они используют `redis-cli` для взаимодействия с узлом. Скрипты можно адаптировать для вашего окружения (например, добавить аутентификацию с `-a <password>` если включена).

#### 1. Простой скрипт (promote_to_master.sh)
Этот скрипт просто отправляет команду `CLUSTER FAILOVER` на указанный узел. Подходит для быстрого ручного вызова.

```bash
#!/bin/bash

# Простой скрипт для возврата роли Master на восстановленный узел Redis Cluster v6.

if [ $# -ne 2 ]; then
    echo "Использование: $0 <host> <port>"
    echo "Пример: $0 192.168.1.10 6379"
    exit 1
fi

HOST=$1
PORT=$2

echo "Инициирую manual failover на узле ${HOST}:${PORT} для возврата роли Master..."

# Отправляем команду CLUSTER FAILOVER (manual takeover)
redis-cli -h "$HOST" -p "$PORT" CLUSTER FAILOVER

echo "Команда отправлена. Проверьте роль: redis-cli -h $HOST -p $PORT ROLE"
echo "Или статус кластера: redis-cli -h $HOST -p $PORT CLUSTER NODES"
```

**Использование**:
- Сохраните в файл, сделайте исполняемым: `chmod +x promote_to_master.sh`.
- Запустите: `./promote_to_master.sh <ip-восстановленного-узла> <port>`.
- После выполнения подождите 5–10 секунд и проверьте роль.

#### 2. Улучшенный скрипт с проверками (restore_master_role.sh)
Этот скрипт проверяет текущую роль узла, выполняет failover только если это slave, и проверяет результат. Более безопасен для автоматизации.

```bash
#!/bin/bash

# Улучшенный скрипт для возврата роли Master на восстановленный узел Redis Cluster v6 с проверками.

if [ $# -ne 2 ]; then
    echo "Использование: $0 <host> <port>"
    echo "Пример: $0 192.168.1.10 6379"
    exit 1
fi

HOST=$1
PORT=$2
TIMEOUT=10  # Таймаут подключения в секундах

echo "Проверка статуса узла ${HOST}:${PORT}..."

# Получаем роль узла (первый элемент ответа ROLE)
CURRENT_ROLE=$(redis-cli -h "$HOST" -p "$PORT" --connect-timeout "$TIMEOUT" ROLE 2>/dev/null | head -n1 | awk '{print $1}')

if [ -z "$CURRENT_ROLE" ]; then
    echo "Ошибка: Не удалось подключиться к ${HOST}:${PORT} или получить роль. Проверьте сеть/сервис."
    exit 1
fi

echo "Текущая роль: $CURRENT_ROLE"

if [ "$CURRENT_ROLE" = "slave" ]; then
    echo "Узел - slave. Инициирую manual failover (CLUSTER FAILOVER)..."
    
    # Выполняем failover
    RESULT=$(redis-cli -h "$HOST" -p "$PORT" CLUSTER FAILOVER 2>/dev/null)
    
    if [[ "$RESULT" == *"OK"* ]]; then
        echo "Команда CLUSTER FAILOVER успешна. Ожидание завершения (5 сек)..."
        sleep 5
        
        # Проверяем новую роль
        NEW_ROLE=$(redis-cli -h "$HOST" -p "$PORT" ROLE 2>/dev/null | head -n1 | awk '{print $1}')
        echo "Новая роль: $NEW_ROLE"
        
        if [ "$NEW_ROLE" = "master" ]; then
            echo "Успех! Узел ${HOST}:${PORT} теперь Master."
        else
            echo "Предупреждение: Роль не изменилась. Проверьте логи Redis (redis-server.log) и CLUSTER NODES."
        fi
    else
        echo "Ошибка failover: $RESULT. Возможно, кластер не готов или узел не реплика."
        exit 1
    fi
elif [ "$CURRENT_ROLE" = "master" ]; then
    echo "Узел уже Master. Действия не требуются."
else
    echo "Неожиданная роль ($CURRENT_ROLE). Завершаю."
    exit 1
fi
```

**Использование**:
- Аналогично простому скрипту: `./restore_master_role.sh <ip> <port>`.
- Скрипт выводит детальную информацию и обрабатывает ошибки (например, если подключение не удалось).

### Автоматизация в кластере
- **Для полного кластера**: Чтобы скрипт работал для любого узла, интегрируйте его с мониторингом. Например, используйте `redis-cli CLUSTER NODES` на любом узле, чтобы найти ID слотов и роли, и примените failover только к нужному (по IP или node ID).
- **Пример расширения**: Добавьте в скрипт парсинг `CLUSTER NODES` для автоматического обнаружения восстановленного узла.
- **Альтернативы**: Для более продвинутой автоматизации рассмотрите Redis Sentinel (для non-cluster) или внешние инструменты вроде Redis Operator в Kubernetes, но для чистого OSS Cluster v6 скрипты — базовый подход.

Если у вас есть дополнительные детали (конфиг redis.conf, логи ошибок), я могу уточнить скрипты!
