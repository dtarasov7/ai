#
import time
from opentelemetry import trace
from opentelemetry.sdk.trace import TracerProvider
from opentelemetry.sdk.trace.export import BatchSpanProcessor
from opentelemetry.exporter.otlp.proto.grpc.trace_exporter import OTLPSpanExporter
from opentelemetry.sdk.resources import Resource, SERVICE_NAME
from opentelemetry.trace import set_span_in_context, StatusCode

# Настройки
OTLP_ENDPOINT = "localhost:4317"
NUM_TRACES = 10  # Сколько трейсов сгенерировать

# Создаём общий exporter
exporter = OTLPSpanExporter(endpoint=OTLP_ENDPOINT, insecure=True)

def create_tracer(service_name: str):
    resource = Resource(attributes={SERVICE_NAME: service_name})
    provider = TracerProvider(resource=resource)
    provider.add_span_processor(BatchSpanProcessor(exporter))
    return provider.get_tracer(__name__)

# Создаём трейсеры
frontend_tracer = create_tracer("frontend")
auth_tracer = create_tracer("auth-service")
db_tracer = create_tracer("database")

for i in range(1, NUM_TRACES + 1):
    is_error = (i % 3 == 0)  # Каждая 3-я итерация — с ошибкой
    print(f"Генерация трейса #{i} {'(с ошибкой)' if is_error else '(успешный)'}")

    with frontend_tracer.start_as_current_span("GET /login") as root_span:
        root_span.set_attribute("http.method", "GET")
        root_span.set_attribute("http.route", "/login")
        root_span.set_attribute("trace.iteration", i)

        auth_context = trace.set_span_in_context(root_span)

        with auth_tracer.start_span("validate_token", context=auth_context) as auth_span:
            auth_span.set_attribute("auth.type", "jwt")
            
            if is_error:
                # Симулируем ошибку в auth-service
                auth_span.set_status(StatusCode.ERROR, "Invalid or expired token")
                auth_span.record_exception(ValueError("Token validation failed"))
                # Не вызываем базу данных при ошибке (реалистично)
            else:
                # Успешный путь: вызываем базу данных
                db_context = trace.set_span_in_context(auth_span)
                with db_tracer.start_span("query_user", context=db_context) as db_span:
                    db_span.set_attribute("db.statement", "SELECT * FROM users WHERE id = ?")
                    db_span.set_attribute("db.system", "postgresql")
                    db_span.add_event("DB query executed")

    # Небольшая задержка для наглядности (опционально)
    time.sleep(0.1)

print(f"\nСгенерировано {NUM_TRACES} трейсов. Каждый 3-й содержит ошибку в 'auth-service'.")