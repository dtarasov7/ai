Рассмотрю основные проблемы при размещении keepalived в двух ЦОД с L2-связностью и варианты их решения:

## Основные проблемы

### 1. **Split-brain сценарий**
**Проблема:** При потере L2-связности между ЦОД оба узла keepalived могут считать себя MASTER и поднять VIP одновременно.

**Решения:**
- Использование третьего узла keepalived в третьем ЦОД как арбитра (quorum node)
- Настройка скриптов проверки доступности (track_script) для мониторинга связности между ЦОД
- Использование unicast вместо multicast для VRRP с явным указанием peer-узлов
- Реализация внешнего арбитража через отдельный сервис мониторинга

### 2. **Асимметричная маршрутизация**
**Проблема:** При активном VIP в ЦОД-1, но входном трафике через ЦОД-2, возможны проблемы с обратным трафиком.

**Решения:**
- Настройка политик маршрутизации (PBR) для корректного возврата трафика
- Использование Direct Server Return (DSR) режима
- Анонсирование VIP через BGP из обоих ЦОД с разными метриками
- Настройка source-based routing

### 3. **Задержки L2 между ЦОД**
**Проблема:** Высокая latency или packet loss может вызывать ложные срабатывания failover.

**Решения:**
- Увеличение VRRP таймеров (advert_int, garp_master_delay)
- Настройка порогов для track_script с учетом задержек
- Использование нескольких независимых L2-линков между ЦОД
- Мониторинг качества канала и динамическая подстройка приоритетов

### 4. **Проблема "флаппинга" VIP**
**Проблема:** Частые переключения MASTER/BACKUP при нестабильном канале.

**Решения:**
- Настройка hysteresis (гистерезиса) для приоритетов
- Использование nopreempt режима
- Реализация "sticky" master через динамические приоритеты
- Настройка delay перед возвратом роли MASTER

## Рекомендуемая архитектура

### **Вариант 1: Трехузловая конфигурация**
```
ЦОД-1: keepalived (priority 100) + application servers
ЦОД-2: keepalived (priority 90) + application servers  
ЦОД-3: keepalived (priority 50) - только quorum
```

Настройки:
- Минимум 2 из 3 узлов должны видеть друг друга для выбора MASTER
- ЦОД-3 никогда не становится MASTER при наличии узлов в ЦОД-1/2

### **Вариант 2: Active-Passive с внешним арбитром**
```
keepalived.conf:
vrrp_script check_arbitrator {
    script "/usr/local/bin/check_quorum.sh"
    interval 5
    weight -200  # снижаем приоритет при недоступности арбитра
}

vrrp_instance VI_1 {
    unicast_peer {
        <IP_другого_ЦОД>
    }
    track_script {
        check_arbitrator
    }
}
```

### **Вариант 3: BGP Anycast**
Отказаться от L2 растяжки в пользу L3 с BGP анонсами:
- Каждый ЦОД анонсирует VIP через BGP
- ECMP или выбор по метрикам
- keepalived управляет только локальным анонсом

## Дополнительные рекомендации

1. **Мониторинг:**
   - Настройка алертов на split-brain ситуации
   - Логирование всех state changes
   - Мониторинг latency между ЦОД

2. **Тестирование:**
   - Регулярные учения по отказу L2-канала
   - Проверка поведения при packet loss
   - Тестирование восстановления после split-brain

3. **Документация:**
   - Четкие процедуры восстановления
   - Матрица приоритетов для разных сценариев
   - Runbook для инцидентов

Оптимальное решение зависит от ваших требований к RTO/RPO и возможностей сетевой инфраструктуры.
