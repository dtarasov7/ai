Ниже — разбор типичных проблем при размещении keepalived/VRRP на два ЦОД с растянутым L2, когда VIP один, балансировки нет, а трафик может зайти в любой из ЦОД или “с третьего места”. В конце — практические варианты решений и примерные настройки.

Контекст (как я понял из условия)
- Два ЦОД с симметричными бэкендами. L2 растянут между ЦОД.
- Один VIP, который поднимает keepalived (VRRP). Балансировки нет — только актив/пассив.
- Входящий трафик может попадать в любой ЦОД или в третью площадку.
- Есть третий ЦОД без бэкендов, куда можно поставить дополнительный keepalived-узел/сервис.

Основные проблемы

1) Split‑brain (двойной MASTER) при разделении между ЦОД
- Причина: потеря связности между ЦОД на уровне, который не видит VRRP (DCI/магистраль), при этом каждый узел считает, что второй умер, и становится MASTER.
- Последствия: конфликт IP/MAC, flapping MAC-адреса по DCI, потери трафика, “залипание” у EVPN/ARP-suppression из-за частых перемещений MAC.
- Усиливающие факторы: multicast VRRP, отсутствие кворума, агрессивные таймеры.

2) Асимметричная маршрутизация и hairpin
- Сценарий: клиент заходит в ЦОД-1, а VIP активен в ЦОД-2 → трафик перетекает через DCI туда-обратно; если на пути есть stateful FW/NAT, разрываются сессии.
- Симптомы: нестабильность, повышенные задержки, внезапные обрывы TCP.

3) Медленная конвергенция ARP/MAC и фильтрация GARP
- При переезде VIP keepalived шлёт Gratuitous ARP. В EVPN/VXLAN может сработать suppression, MAC mobility dampening, rate-limit GARP, в результате часть трафика продолжает идти “в старый” ЦОД.
- Симптомы: секундные/десятки секунд “дыр”.

4) Слишком агрессивные таймеры VRRP
- Малый advert_int и preempt вызывают ping-pong при кратковременных потерях пакетов/джиттере между ЦОД. В EVPN это быстро приводит к MAC mobility penalty.

5) Неочевидная семантика “здоровья”
- keepalived сам по себе не знает, “живы” ли бэкенды в этом ЦОД. Можно случайно поднять MASTER там, где бэкенды мёртвые, хотя в другом ЦОД всё ок.
- Нужна деградация priority на основе health-check бэкендов и внешней связности.

6) Ограничения/безопасность VRRP в растянутом L2
- Multicast 224.0.0.18 может быть отфильтрован по пути; VRRPv3 не имеет “auth” как у v2 PASS/AH; L2-доступность увеличивает площадь атаки (spoof VRRP).

7) Большая L2-домен/широковещание
- Рост broadcast/unknown-unicast, риск петель, влияние L2-аварий сразу на оба ЦОД.

8) Плановые работы и “drain”
- Переключение MASTER рвёт существующие соединения (балансировки нет). Нужны механизмы “плавной” эвакуации новых сессий, а также взаимодействие с FW/ACL.

Рабочие варианты решений

A) Оставить единый VIP на растянутом L2, но “застраховать” VRRP
Когда менять архитектуру нельзя, делаем VRRP максимально предсказуемым.

- Анти‑split‑brain:
  - Включить unicast VRRP (в keepalived — vrrp_unicast_peer) между узлами в обоих ЦОД.
  - Добавить “кворум” через третий ЦОД: track_script, который снижает priority, если нет связности с “witness” в 3‑м ЦОД и/или с пирами в соседнем ЦОД. Идея: MASTER только при достижении внешнего кворума.
  - Дополнительно трекать состояние DCI (линк/ROUTE до соседнего ЦОД) — при потере снижать priority.

- Предсказуемость и анти‑флаппинг:
  - Включить nopreempt и/или preempt_delay, чтобы не отбирать роль MASTER у действующего узла без необходимости.
  - Увеличить advert_int (например, 1 с) и skew_factor для устойчивости к джиттеру между ЦОД.
  - Тюн GARP: garp_master_delay, garp_master_repeat/refresh, учесть лимиты на коммутаторах/EVPN.

- Безопасность и L2‑гигиена:
  - Выделенный VLAN под VIP и VRRP, storm‑control, контроль multicast.
  - Если VRRPv2 — использовать auth PASS/AH; если v3 — фильтры на портах/порт-секьюрити.
  - ACL против чужих VRRP с чужих интерфейсов.

- Здоровье бэкендов:
  - vrrp_track_script, который снижает priority, если локальные бэкенды недоступны (весомо, чтобы власть ушла во второй ЦОД, где бэкенды живы).

- Маршрутизация/симметрия:
  - Если есть stateful межсетевые экраны между ЦОД/наружу — обеспечить симметрию: либо пиннинг мастерства к тому ЦОД, где заходит трафик (см. GSLB ниже), либо SNAT на выходе через тот же ЦОД, либо устранить stateful на транзите.

Пример скелета keepalived (идея, не полный конфиг)
```
vrrp_script chk_quorum {
  script "/usr/local/bin/check_quorum.sh"   # проверяем reachability: peer-1, peer-2, witness-1/2
  interval 2
  fall 2
  rise 2
  weight -150                                # достаточно, чтобы опустить priority ниже BACKUP
}

vrrp_script chk_backends {
  script "/usr/local/bin/check_backends.sh"  # локальные healthchecks (TCP/HTTP)
  interval 5
  fall 2
  rise 3
  weight -50
}

vrrp_instance VIP_DC {
  state BACKUP
  interface bond0.V123
  virtual_router_id 42
  priority 200                                # в “предпочтительном” ЦОД
  advert_int 1
  nopreempt                                   # удерживаем стабильность
  garp_master_delay 1
  garp_master_repeat 5
  unicast_peer {
    10.0.123.2   # peer DC
    10.0.223.3   # optional: “смотритель”/relay в DC3 (если используете relay)
  }
  track_script {
    chk_quorum
    chk_backends
  }
  virtual_ipaddress {
    192.0.2.10/24 dev bond0.V123
  }
  notify_master "/usr/local/bin/on_master.sh"   # дренирование/анонсы
  notify_backup "/usr/local/bin/on_backup.sh"
  notify_fault  "/usr/local/bin/on_fault.sh"
}
```
Скрипт check_quorum может считать “очки” за достижимость пиров и witness‑IP в 3‑м ЦОД и возвращать exit!=0 при недостаточном кворуме.

Плюсы: минимум изменений, быстрый внедряемый план. Минусы: остаётся зависимость от L2/EVPN, риск hairpin, сложнее гарантировать симметрию.

B) Уйти от L2‑VIP: Anycast VIP через BGP (рекомендовано)
Идея: VIP становится /32 маршрутом, который объявляется из активного ЦОД по BGP (к провайдерам/ядру). keepalived управляет объявлением (через notify‑скрипты → FRR/ExaBGP), а не переносит MAC по L2. В обоих ЦОД можно держать готовый “standby‑анонс”, но активным делает только один.

- Преимущества:
  - Нет MAC‑мобильности/ARP‑задержек, быстрый converge по BGP.
  - Минимум hairpin: трафик приходит в ближайший по IGP/EBGP ЦОД.
  - Проще симметрия, особенно при выходе в Интернет из каждого ЦОД.

- Как связать с keepalived:
  - keepalived продолжает решать “кто MASTER”, а скрипт в notify_master делает “announce VIP /32” в FRR (network в VRF/addr‑family) или через ExaBGP; notify_backup — withdraw.
  - Здоровье бэкендов и внешней связности учитывается в priority/announce.

- Где пригодится третий ЦОД:
  - Как route‑reflector/RS, как witness для кворума, либо независимый upstream для проверки reachability.

Минусы: нужна готовность к BGP на границе/ядре; возможно изменение политики провайдеров.

C) Два VIP (по одному на ЦОД) + GSLB/DNS/Geo
Делим: VIP_DC1 и VIP_DC2 — каждый живёт только в своём L2. Снаружи клиенты получают адрес ближайшего/здорового ЦОД через:
- GSLB (F5 GTM, NS1, Route53, Cloudflare Load Balancer и т.п.) с активными health‑check,
- или простое DNS с TTL 20–60 c + регулярные проверки/вырубание нерабочего IP.

Плюсы: L2 между ЦОД теперь не критичен для VIP; минимум MAC‑флаппинга. Минусы: DNS‑кэш, не мгновенное переключение, сложнее обеспечить “один и тот же IP”.

D) L4/L7 глобальный балансировщик поверх (если допустимо)
Поставить глобальный LB (апплианс/облако), который имеет публичный адрес и сам довозит до нужного ЦОД. VIP keepalived — уже за ним, локальный.

Роль третьего ЦОД (чем он полезен)
- Witness/кворум для решения “кто MASTER” (простое и эффективное).
- Независимый мониторинг внешней доступности (пинг/HTTP снаружи).
- BGP‑инфраструктура (RR/RS) для варианта B.
- Хранение состояния/лидер‑элект (Consul/etcd) — если хотите более строгий кворум поверх keepalived через track_script.

Практические рекомендации и чек‑лист

Сетевые настройки
- Если остаетесь на L2‑VIP: выделите отдельный VLAN, проверьте, что VRRP unicast проходит детерминированно; отключите/учтите IGMP‑snooping влияние на VRRP multicast.
- В EVPN/VXLAN проверьте MAC Mobility/ARP Suppression параметры; при флаппинге — включите nopreempt и увеличьте advert_int.
- Настройте storm‑control и rate‑limit GARP на коммутаторах внимательно, чтобы не “съесть” GARP VIP.

Таймеры и стабильность
- VRRP advert_int ~ 1 c, nopreempt, preempt_delay 5–30 c (если нужен контроль), garp_master_repeat 3–5.
- При межЦОД‑джиттере не стремитесь к failover <1 c — лучше надёжные 2–5 c, чем флаппинг.

Здоровье/приоритеты
- track_script для бэкендов: если в ЦОД все бэкенды умерли — снижать priority значительно.
- track_interface uplink/DCI: потеряли аплинк — тут же отдаём MASTER.
- Кворум от 3‑го ЦОД: без него — не становиться MASTER.

Маршрутизация и stateful
- Если есть stateful FW/NAT по пути клиента, обеспечьте симметрию (policy‑based routing, SNAT на выход) или переезжайте на BGP anycast.
- Для наружных клиентов лучше вариант B/C, чтобы не тащить сессии через DCI.

Обслуживание и “drain”
- notify_master/backup скрипты: при переходе в BACKUP — закрывайте прием новых соединений, давайте доработать активным, по возможности синхронизируйте conntrack между FW.

Безопасность
- Если VRRPv2 — auth PASS/AH; фильтруйте VRRP трафик, ограничьте L2‑доступ.
- Мониторинг: алерты на двойной MASTER, MAC‑flap, частые переезды VIP.

Что выбрать
- Если можно менять архитектуру: BGP anycast (вариант B) — самый чистый и предсказуемый способ для двух ЦОД и “третьего места”.
- Если менять нельзя и нужен один VIP в L2: усиленный VRRP с кворумом (вариант A).
- Если один IP не обязателен: два VIP + GSLB (вариант C) — часто самый практичный компромисс.

Могу предложить карточку решения под ваши вводные, если уточните:
- EVPN/VXLAN или “голый” L2? Есть ли MAC mobility dampening?
- Есть ли stateful FW/NAT между ЦОД/наружу?
- Готовы ли поднимать BGP/FRR/ExaBGP на границе?
- Нужен ли строго один публичный IP или допустимо два?
- Целевое время failover (SLA) и это для TCP/UDP?
