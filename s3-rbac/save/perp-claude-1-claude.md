# Требования к функциональным возможностям подсистемы RBAC объектного хранилища S3

## 1. Управление пользователями и учетными записями

### 1.1 Модель пользователей
- Поддержка создания пользователей с уникальными идентификаторами (UID)
- Возможность назначения отображаемого имени (display name) для каждого пользователя
- Генерация и управление парами ключей доступа (access key / secret key) для аутентификации S3
- Поддержка создания подпользователей (subusers) с собственными ключами для протокола Swift
- Возможность создания системных (system) и административных (admin) пользователей с расширенными правами

### 1.2 Мультитенантность
- Поддержка изоляции пользователей и ресурсов на уровне тенантов (tenant)
- Возможность создания пользователей в контексте конкретного тенанта с синтаксисом `<tenant>$<user>`
- Поддержка операций с бакетами через синтаксис `<tenant>:<bucket>` для доступа к ресурсам других тенантов
- Каждый тенант должен иметь собственное пространство имен для бакетов
- Поддержка неявного тенанта (legacy tenant) с пустым именем для обратной совместимости

## 2. Политики управления доступом

### 2.1 Bucket Policies (Политики бакетов)
- Поддержка политик на уровне бакетов в формате AWS IAM Policy (JSON)
- Версия политик: "2012-10-17"
- Структура политики должна включать:
  - `Version` - версия формата политики
  - `Statement` - массив правил с элементами:
    - `Effect`: "Allow" или "Deny"
    - `Principal`: идентификация субъектов через ARN формата `arn:aws:iam:::user/<username>`
    - `Action`: список разрешенных/запрещенных операций S3
    - `Resource`: целевые ресурсы в формате `arn:aws:s3:::<bucket>` и `arn:aws:s3:::<bucket>/*`
    - `Condition`: опциональные условия применения правила

### 2.2 Поддерживаемые S3 Actions
Система должна поддерживать следующие операции S3 в политиках:
- **Bucket operations**: s3:CreateBucket, s3:DeleteBucket, s3:ListBucket, s3:ListBucketVersions, s3:ListBucketMultipartUploads
- **Object operations**: s3:GetObject, s3:PutObject, s3:DeleteObject, s3:GetObjectVersion, s3:DeleteObjectVersion
- **ACL operations**: s3:GetObjectAcl, s3:PutObjectAcl, s3:GetBucketAcl, s3:PutBucketAcl
- **Multipart operations**: s3:ListMultipartUploadParts, s3:AbortMultipartUpload
- **Versioning**: s3:GetBucketVersioning, s3:PutBucketVersioning

### 2.3 Условные ключи (Condition Keys)
Поддержка следующих ключей условий для политик:
- `aws:CurrentTime` - текущее время запроса
- `aws:EpochTime` - время в формате Unix timestamp
- `aws:PrincipalType` - тип субъекта запроса
- `aws:Referer` - HTTP referer заголовок
- `aws:SecureTransport` - использование HTTPS
- `aws:SourceIp` - IP-адрес источника запроса
- `aws:UserAgent` - User-Agent клиента
- `aws:username` - имя пользователя

## 3. Роли и временные учетные данные (STS)

### 3.1 Управление ролями
- Создание и управление ролями через административный API
- Каждая роль должна содержать:
  - Уникальный идентификатор и имя роли
  - ARN в формате `arn:aws:iam:::role/<path>/<role-name>`
  - Политику доверия (AssumeRolePolicyDocument)
  - Максимальную длительность сессии (max_session_duration)
  - Опциональный путь (path) для организационной иерархии
- Возможность присоединения inline-политик к ролям (permission policies)
- Поддержка тегов для ролей (multivalued tags)

### 3.2 STS API операции
- **AssumeRole**: получение временных учетных данных для доступа от имени роли
  - Параметры: RoleArn, RoleSessionName, DurationSeconds, Policy (optional)
  - Проверка разрешений как со стороны роли, так и со стороны вызывающего пользователя
  
- **AssumeRoleWithWebIdentity**: получение временных учетных данных через OpenID Connect/OAuth2.0
  - Поддержка федеративной аутентификации через внешние IDP
  - Проверка JWT токенов
  - Создание shadow-пользователей в отдельном namespace 'oidc'
  - Поддержка claims в условиях trust policy (sub, azp и др.)

### 3.3 Ограничения временных учетных данных
- Временные учетные данные могут быть дополнительно ограничены через параметр Policy в запросе
- Эффективные права определяются пересечением прав роли и переданной политики
- Длительность сессии должна быть настраиваемой (с учетом max_session_duration роли)

## 4. Access Control Lists (ACL)

### 4.1 Уровни применения ACL
- Поддержка ACL на уровне бакетов
- Поддержка ACL на уровне объектов
- Каждый grant в ACL должен иметь различную семантику для бакетов и объектов

### 4.2 Стандартные разрешения ACL
- READ - чтение объектов/листинг бакета
- WRITE - запись объектов/создание, перезапись и удаление объектов в бакете
- READ_ACP - чтение ACL
- WRITE_ACP - изменение ACL
- FULL_CONTROL - все разрешения

### 4.3 Grantee типы
- Конкретные пользователи (по UID или email)
- Группы (по URI, например, http://acs.amazonaws.com/groups/global/AllUsers)

## 5. Интеграция с внешними системами аутентификации

### 5.1 Keystone интеграция
- Поддержка аутентификации через OpenStack Keystone
- Service token support для Keystone auth
- Автоматическое создание пользователей на основе Keystone-токенов
- Возможность включения мультитенантности на основе Keystone (rgw_keystone_implicit_tenants)

### 5.2 LDAP поддержка
- Возможность конфигурации LDAP URI для аутентификации
- Интеграция с корпоративными директориями

## 6. Мультитенантность через Placement Targets и Pool

### 6.1 Placement Targets (Цели размещения)
**Критически важно для мультитенантности**: Система должна обеспечивать изоляцию данных различных тенантов через механизм placement targets и pools.

- Поддержка множественных placement targets в конфигурации zonegroup
- Каждый placement target должен определять:
  - Уникальный идентификатор размещения (placement-id)
  - Набор storage classes
  - Опциональные теги (tags) для контроля доступа
- Начальный placement target с именем "default-placement" должен создаваться автоматически

### 6.2 Storage Classes (Классы хранения)
- Каждый placement target должен поддерживать множественные storage classes
- Обязательный класс хранения "STANDARD" для каждого placement target
- Возможность создания дополнительных классов: STANDARD_IA, GLACIER и пользовательских
- Каждый storage class сопоставляется с конкретными пулами хранения в zone конфигурации

### 6.3 Mapping на пулы хранения (Pool Mapping)
Для обеспечения физической изоляции данных тенантов через пулы:

- Zone конфигурация должна определять mapping placement targets на конкретные пулы:
  - `index_pool` - пул для индексов бакетов
  - `data_pool` - пул для данных объектов (для каждого storage class)
  - `data_extra_pool` - пул для метаданных незавершенных multipart uploads
  
- Примерная структура в zone:
```json
"placement_pools": [{
  "key": "tenant-a-placement",
  "val": {
    "index_pool": "tenant-a.rgw.buckets.index",
    "storage_classes": {
      "STANDARD": {
        "data_pool": "tenant-a.rgw.buckets.data"
      }
    },
    "data_extra_pool": "tenant-a.rgw.buckets.non-ec"
  }
}]
```

### 6.4 Назначение placement targets пользователям
- Пользователь должен иметь возможность иметь default_placement в своем профиле
- Placement target бакета выбирается при создании и не может быть изменен
- Пользователь может переопределить placement target при создании бакета через LocationConstraint (S3) или X-Storage-Policy (Swift)

### 6.5 Контроль доступа через placement tags
**Ключевой механизм изоляции тенантов:**
- Placement target может иметь набор тегов (tags)
- Пользователь может создать бакет с определенным placement target только если:
  - У placement target нет тегов (доступен всем), ИЛИ
  - placement_tags пользователя содержит хотя бы один совпадающий тег
- Это позволяет ограничить доступ определенных пользователей к определенным типам хранилища/тенантам

Пример изоляции тенантов:
- Tenant A: пользователи имеют placement_tags: ["tenant-a"], могут создавать бакеты только в placement target "tenant-a-storage" с тегами ["tenant-a"]
- Tenant B: пользователи имеют placement_tags: ["tenant-b"], могут создавать бакеты только в placement target "tenant-b-storage" с тегами ["tenant-b"]
- При этом каждый placement target mapped на отдельные пулы, обеспечивая физическую изоляцию данных

### 6.6 Управление placement через административный API
- Операции добавления placement target в zonegroup
- Операции добавления zone placement info с указанием пулов
- Установка default placement для zonegroup
- Изменение default_placement и placement_tags для пользователей

## 7. Квоты и ограничения

### 7.1 Квоты пользователей
- Возможность установки квот на максимальное количество объектов
- Возможность установки квот на максимальный размер хранилища
- Квоты должны применяться на уровне пользователя

### 7.2 Квоты бакетов
- Возможность установки квот на уровне отдельных бакетов
- Поддержка операций проверки квот через administrative API

### 7.3 Rate Limiting (Ограничение скорости)
- Поддержка ограничения скорости запросов на уровне пользователя
- Поддержка ограничения скорости запросов на уровне бакета
- Возможность раздельного ограничения READ и WRITE операций
- Ограничения в единицах операций/минуту и байт/минуту

## 8. Административные возможности

### 8.1 Capabilities (Административные права)
- Система capabilities для предоставления административных прав пользователям
- Основные категории capabilities:
  - `users` - управление пользователями
  - `buckets` - управление бакетами
  - `metadata` - управление метаданными
  - `usage` - просмотр статистики использования
  - `zone` - управление зонами
  - `roles` - управление ролями
- Уровни доступа для каждой категории: read, write, или * (все)

### 8.2 Системные пользователи
- Возможность создания пользователей с флагом system
- Системные пользователи не подлежат квотам
- Системные пользователи могут иметь особые права административного доступа

### 8.3 Игнорирование ошибок политик
- Admin и system пользователи должны игнорировать ошибки парсинга IAM политик
- Это обеспечивает работоспособность административных операций даже при некорректных политиках

## 9. Безопасность и аудит

### 9.1 Аутентификация
- Поддержка AWS Signature Version 4
- Валидация x-amz-content-sha256 для пустых payload
- Игнорирование проверки подписи для HTTP OPTIONS запросов
- Поддержка временных учетных данных из STS

### 9.2 Шифрование
- Поддержка Server-Side Encryption (SSE)
- Политики IAM должны поддерживать проверку crypt attributes для PostObject и Multipart операций
- Возможность установки default encryption key через конфигурацию

### 9.3 Логирование и мониторинг
- Возможность отслеживания операций через административный API
- Поддержка bucket logging для аудита доступа

## 10. Совместимость с S3 API

### 10.1 Bucket операции
- CreateBucket с поддержкой LocationConstraint для выбора placement target
- DeleteBucket
- ListBuckets
- HeadBucket
- GetBucketLocation
- GetBucketVersioning / PutBucketVersioning
- GetBucketPolicy / PutBucketPolicy / DeleteBucketPolicy

### 10.2 Object операции
- PutObject с поддержкой storage class header
- GetObject
- DeleteObject
- CopyObject
- HeadObject
- ListObjects / ListObjectsV2 с корректным возвратом владельцев объектов
- Multipart Upload операции

### 10.3 Bucket Lifecycle
- Поддержка правил перехода объектов между storage classes
- Автоматизация перемещения объектов на основе возраста и правил

## 11. Уведомления и интеграция

### 11.1 Bucket Notifications
- Поддержка S3 Bucket Notifications
- Поддержка topics с тенантами в административных операциях
- Корректный формат событий (eTag вместо etag, без префикса s3: в eventName)

### 11.2 Интеграция с очередями
- Поддержка AMQP для уведомлений
- Поддержка Kafka для уведомлений

## 12. Требования к производительности и масштабируемости

### 12.1 Конфигурация пулов
- Поддержка настройки compression для storage classes
- Возможность использования различных типов пулов (replicated, erasure-coded)
- Независимая конфигурация пулов для индексов и данных

### 12.2 Multisite (опционально)
- Поддержка репликации между зонами
- Корректная репликация зашифрованных multipart uploads
- Синхронизация placement конфигураций между зонами

## 13. Дополнительные требования

### 13.1 Обратная совместимость
- Поддержка legacy buckets (созданных до внедрения мультитенантности)
- Обеспечение dual-API capability (S3 и Swift) для существующих бакетов

### 13.2 Документирование
- Административный API должен быть полностью документирован
- Примеры использования для всех основных операций RBAC
- Руководство по миграции с учетом placement и tenant конфигураций

---

**Примечание**: Все функциональные возможности должны соответствовать уровню зрелости и стабильности, достигнутому в референсном решении на момент версии 17.2.7 (Quincy), без включения функциональности, появившейся в более поздних версиях.
