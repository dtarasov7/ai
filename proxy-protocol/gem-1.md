Вот пример конфигурации для **Angie** (или Nginx Plus), работающего как L4 балансировщик (TCP) с включенным протоколом PROXY и активными проверками доступности (Health Checks).

### Основные моменты конфигурации:
1.  **Контекст `stream`**: Для L4 балансировки используется блок `stream`, а не `http`.
2.  **`proxy_protocol on;`**: Эта директива заставляет Angie добавлять заголовок PROXY (v1 или v2) к каждому соединению с бэкендом, передавая реальный IP клиента.
3.  **`health_check`**: Angie поддерживает активные проверки в блоке stream.
4.  **`zone`**: Для работы активных проверок и статистики в блоке `upstream` обязательно должна быть объявлена зона разделяемой памяти.

### Конфигурация Angie (`/etc/angie/angie.conf`)

```nginx
user angie;
worker_processes auto;

events {
    worker_connections 1024;
}

# Блок stream для L4 балансировки (TCP)
stream {
    # Определение группы апстримов
    upstream backend_nginx {
        # Зона разделяемой памяти (обязательно для health_check)
        zone backend_zone 64k;

        # Список ваших Nginx серверов
        server 192.168.1.10:443;
        server 192.168.1.11:443;
        server 192.168.1.12:443;
    }

    server {
        # Слушаем порт 443 (TCP)
        listen 443; 
        # Если нужно UDP, добавьте 'udp' в listen, но для HTTPS это TCP

        # Перенаправляем трафик на группу серверов
        proxy_pass backend_nginx;

        # Включаем отправку PROXY protocol (v1 - текстовый, или v2 - бинарный)
        # Обычно достаточно просто 'on', Angie выберет версию.
        # Nginx (upstream) по умолчанию понимает v1.
        proxy_protocol on; 

        # Настройка тайм-аутов (опционально, но полезно)
        proxy_connect_timeout 5s;
        proxy_timeout 10m;

        # Активная проверка доступности
        # Angie будет подключаться к бэкендам, чтобы проверить, жив ли порт.
        # interval=5s: проверять каждые 5 секунд
        # passes=2: считать живым после 2 успешных проверок
        # fails=3: считать мертвым после 3 неудач
        health_check interval=5s passes=2 fails=3;
    }
}
```

### Важное примечание по Health Check и PROXY Protocol

Поскольку трафик на порту 443 зашифрован (TLS), Angie в режиме L4 (stream) не может заглянуть внутрь пакета, чтобы сделать HTTP-проверку (например, `GET /health`), не разрывая SSL (SSL Termination).

В данной конфигурации `health_check` выполняет простую **TCP-проверку** (успешное установление соединения).

**Проблема:** Если на бэкенд-Nginx настроен `listen 443 ssl proxy_protocol;`, он ожидает заголовок PROXY сразу после соединения. Стандартная TCP-проверка Angie этот заголовок не отправляет. Это может приводить к тому, что в логах бэкенда будут появляться ошибки "broken header" при проверках здоровья, хотя трафик клиентов будет ходить нормально.

**Решение:**
Если ошибки в логах бэкенда критичны, лучше настроить на бэкенд-серверах отдельный порт для проверки здоровья (например, 8080), который не требует SSL и PROXY protocol, и проверять его:

```nginx
# (В блоке server Angie)
health_check port=8080 interval=5s;
```

---

### Как должен быть настроен Upstream (Nginx)

Чтобы бэкенд-Nginx корректно принимал IP клиента от Angie, его конфигурация должна выглядеть примерно так:

```nginx
# Конфиг на серверах 192.168.1.10-12
server {
    # Принимаем SSL и ожидаем PROXY protocol
    listen 443 ssl proxy_protocol; 

    # Настройки SSL
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;

    # Настройка модуля RealIP, чтобы заменить IP балансировщика на IP клиента
    set_real_ip_from 192.168.1.0/24; # IP адрес(а) вашего Angie
    real_ip_header proxy_protocol;
    
    location / {
        root /var/www/html;
    }
}
```
