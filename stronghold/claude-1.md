# Интеграция Stronghold с приложениями в Deckhouse

Рассмотрю несколько подходов к инжекции секретов из Stronghold в приложения, развернутые в Deckhouse.

## Решение 1: External Secrets Operator (ESO) с Stronghold API

### Описание
External Secrets Operator синхронизирует секреты из внешних хранилищ (включая Stronghold через его API) в Kubernetes Secrets.### Конфигурация### Требования к приложению
- Приложение должно уметь читать секреты из переменных окружения или файлов
- Поддержка graceful reload при изменении секретов (опционально)
- Нет специальных требований к коду

### Плюсы
- ✅ Стандартное K8s-решение, широко используется
- ✅ Автоматическая синхронизация секретов
- ✅ Поддержка множества backend'ов (легко мигрировать)
- ✅ Шаблонизация и трансформация секретов
- ✅ Не требует изменений в приложении
- ✅ Централизованное управление через CRD

### Минусы
- ❌ Секреты хранятся в etcd кластера (даже в зашифрованном виде)
- ❌ Дополнительный компонент в кластере
- ❌ Задержка синхронизации (refreshInterval)
- ❌ При компрометации кластера секреты доступны

---

## Решение 2: Secrets Store CSI Driver

### Описание
CSI Driver монтирует секреты из Stronghold напрямую в Pod как tmpfs volumes, минуя Kubernetes Secrets.### Конфигурация### Требования к приложению
- Приложение должно читать секреты из файлов (рекомендуется)
- Желательна поддержка inotify для отслеживания изменений файлов
- Для автоматического reload нужна поддержка SIGHUP или file watching

### Плюсы
- ✅ Секреты НЕ хранятся в etcd
- ✅ Секреты монтируются как tmpfs (в памяти)
- ✅ Автоматическая ротация секретов
- ✅ Меньше прав доступа к API Kubernetes
- ✅ Лучшая безопасность (секреты живут только в Pod)

### Минусы
- ❌ Требуется разработка кастомного CSI провайдера для Stronghold
- ❌ Сложнее в настройке и отладке
- ❌ Требует изменений в приложении (чтение из файлов)
- ❌ Дополнительная нагрузка на ноды (DaemonSet)

---

## Решение 3: Init Container + Stronghold CLI

### Описание
Init-контейнер забирает секреты из Stronghold при старте Pod и сохраняет в shared volume.### Конфигурация### Требования к приложению
- Приложение должно читать секреты из файлов или переменных окружения
- Для сценария с sidecar: поддержка reload по SIGHUP или file watching
- Желательна поддержка graceful shutdown

### Плюсы
- ✅ Простая реализация, не требует дополнительных операторов
- ✅ Полный контроль над процессом загрузки секретов
- ✅ Секреты в памяти (emptyDir с medium: Memory)
- ✅ Гибкость в обработке и трансформации секретов
- ✅ Работает с любым Stronghold API

### Минусы
- ❌ Секреты загружаются только при старте Pod (без sidecar)
- ❌ Требуется перезапуск Pod для обновления секретов
- ❌ Дополнительная разработка CLI/скриптов
- ❌ Sidecar добавляет overhead на ресурсы

---

## Решение 4: Kubernetes Mutating Webhook + Stronghold Injector

### Описание
Webhook автоматически модифицирует Pod спецификации, добавляя init/sidecar контейнеры для инжекции секретов.### Конфигурация### Требования к приложению
- Приложение должно читать секреты из файлов по пути `/vault/secrets/*`
- Минимальные изменения - только добавление аннотаций к Pod
- Опционально: поддержка reload при изменении файлов

### Плюсы
- ✅ Прозрачная инжекция, минимальные изменения в манифестах
- ✅ Консистентный подход для всех приложений
- ✅ Гибкая конфигурация через аннотации
- ✅ Автоматическое обновление секретов через sidecar
- ✅ Централизованное управление политиками

### Минусы
- ❌ Сложность разработки и поддержки webhook сервера
- ❌ Критичный компонент (влияет на создание Pod'ов)
- ❌ Требует настройки TLS сертификатов
- ❌ Overhead на каждый Pod (sidecar)
- ❌ Сложнее отладка проблем

---

## Сравнительная таблица решений## Гибридный подход

Для максимальной гибкости можно комбинировать решения:## Дополнительные рекомендации

### Безопасность
1. **Encryption at rest** - включите шифрование etcd в Deckhouse
2. **RBAC** - ограничьте доступ к Secrets минимальными правами
3. **Network Policies** - изолируйте Pod'ы с доступом к Stronghold
4. **Audit logging** - логируйте доступ к секретам
5. **Pod Security Standards** - используйте restricted политики

### Мониторинг
```yaml
# Prometheus метрики для отслеживания
- stronghold_secret_sync_errors_total
- stronghold_secret_sync_duration_seconds
- stronghold_secret_last_sync_timestamp
- stronghold_secret_rotation_total
```

### Disaster Recovery
- Регулярные бэкапы Stronghold
- Документирование процесса восстановления
- Тестирование сценариев отказа
- План действий при компрометации секретов

Все решения имеют свои преимущества и недостатки. Выбор зависит от ваших требований к безопасности, сложности инфраструктуры и готовности команды поддерживать решение.
